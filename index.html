<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegy S - Образовательный Бот</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --dark-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --card-bg-light: rgba(255, 255, 255, 0.85);
            --card-bg-dark: rgba(30, 30, 46, 0.85);
            --button-gradient: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            --pulse-color: rgba(255, 255, 255, 0.4);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 8px 32px rgba(0, 0, 0, 0.3);
            --text-light: #1a1a2e;
            --text-dark: #e2e8f0;
            --card-text-light: #334155;
            --card-text-dark: #cbd5e1;
            --input-bg-light: #f1f5f9;
            --input-bg-dark: #475569;
            --input-text-light: #1e293b;
            --input-text-dark: #f8fafc;
            --quiz-option-light: #e2e8f0;
            --quiz-option-dark: #334155;
            --quiz-hover-light: #cbd5e1;
            --quiz-hover-dark: #475569;
            --progress-bg-light: #cbd5e1;
            --progress-bg-dark: #64748b;
            --progress-fill: #4ade80;
            --favorite-btn-color: #ef4444;
            --remove-btn-bg: #f87171;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--primary-gradient);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            animation: fadeIn 0.5s ease-out;
            transition: background 0.5s ease, color 0.5s ease;
            position: relative;
        }

        body.dark {
            background: var(--dark-gradient);
            color: var(--text-dark);
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.03;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            width: 100%;
            text-align: center;
            padding: 15px 0;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-light);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark header {
            background: rgba(0, 0, 0, 0.25);
            box-shadow: var(--shadow-dark);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 1.8rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .user-greeting {
            font-size: 1.1rem;
            margin-top: 5px;
            font-weight: 500;
            opacity: 0.9;
        }

        .section {
            background: var(--card-bg-light);
            border-radius: 20px;
            padding: 25px;
            margin: 20px;
            width: calc(100% - 40px);
            max-width: 600px;
            box-shadow: var(--shadow-light);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: cardAppear 0.4s ease-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        body.dark .section {
            background: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark .section:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        @keyframes cardAppear {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .button {
            background: var(--button-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            margin: 12px 5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: calc(100% - 10px);
            max-width: 300px;
            position: relative;
            overflow: hidden;
        }

        .button i {
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .button:hover::before {
            left: 100%;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body.dark .button:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .flashcard {
            background: white;
            color: var(--card-text-light);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .flashcard:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        body.dark .flashcard {
            background: #1e293b;
            color: var(--card-text-dark);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }

        body.dark .flashcard:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .flashcard img {
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            height: 160px;
            object-fit: cover;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .flashcard img:hover {
            transform: scale(1.03);
        }

        .flashcard .speak-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--info-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .flashcard .speak-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .quiz-container {
            margin: 25px 0;
            padding: 5px;
        }

        .quiz-question {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-light);
        }

        body.dark .quiz-question {
            color: var(--text-dark);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        .quiz-option {
            background: var(--quiz-option-light);
            color: var(--input-text-light);
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-weight: 500;
            text-align: center;
            border: 2px solid transparent;
        }

        body.dark .quiz-option {
            background: var(--quiz-option-dark);
            color: var(--input-text-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .quiz-option:hover {
            background: var(--quiz-hover-light);
            transform: translateY(-2px);
        }

        body.dark .quiz-option:hover {
            background: var(--quiz-hover-dark);
        }

        .quiz-option.selected {
            border-color: var(--info-color);
            background: rgba(59, 130, 246, 0.1);
        }

        body.dark .quiz-option.selected {
            background: rgba(59, 130, 246, 0.2);
        }

        .quiz-option.correct {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.15);
        }

        body.dark .quiz-option.correct {
            background: rgba(34, 197, 94, 0.25);
        }

        .quiz-option.incorrect {
            border-color: var(--error-color);
            background: rgba(239, 68, 68, 0.15);
        }

        body.dark .quiz-option.incorrect {
            background: rgba(239, 68, 68, 0.25);
        }

        .quiz-input-container {
            display: flex;
            margin: 20px 0;
            gap: 10px;
        }

        .quiz-input {
            flex: 1;
            padding: 14px 18px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: var(--input-bg-light);
            color: var(--input-text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        body.dark .quiz-input {
            background: var(--input-bg-dark);
            color: var(--input-text-dark);
        }

        .quiz-input:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        body.dark .quiz-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }

        .result {
            font-size: 1.1rem;
            margin: 15px 0;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .result.correct {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success-color);
        }

        .result.incorrect {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error-color);
        }

        .about-text {
            font-size: 1rem;
            line-height: 1.7;
            text-align: justify;
        }

        .level-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .progress-bar {
            background: var(--progress-bg-light);
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        body.dark .progress-bar {
            background: var(--progress-bg-dark);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-fill {
            background: var(--progress-fill);
            height: 100%;
            border-radius: 10px;
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .award {
            font-size: 3rem;
            animation: bounce 1s ease infinite;
            display: block;
            text-align: center;
            margin: 25px 0;
            color: gold;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .search-container {
            position: relative;
            margin: 20px 0;
        }

        .search-input {
            padding: 14px 20px 14px 45px;
            width: 100%;
            border-radius: 12px;
            border: 2px solid transparent;
            background: var(--input-bg-light);
            color: var(--input-text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        body.dark .search-input {
            background: var(--input-bg-dark);
            color: var(--input-text-dark);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        body.dark .search-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        body.dark .search-icon {
            color: #cbd5e1;
        }

        iframe {
            width: 100%;
            height: 220px;
            border-radius: 16px;
            margin: 20px 0;
            border: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        body.dark iframe {
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .profile-section {
            text-align: center;
        }

        .badge {
            font-size: 2.5rem;
            margin: 10px;
            display: inline-block;
            animation: badgePulse 2s infinite;
        }

        @keyframes badgePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .streak {
            font-size: 2rem;
            color: gold;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .daily-challenge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        body.dark .daily-challenge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.03));
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .favorite-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: transparent;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #cbd5e1;
            z-index: 2;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: var(--favorite-btn-color);
        }

        .favorites-list {
            margin-top: 35px;
            padding-top: 25px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        body.dark .favorites-list {
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .remove-fav {
            background: var(--remove-btn-bg);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            margin-top: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .remove-fav:hover {
            background: #ef4444;
        }

        footer {
            width: 100%;
            text-align: center;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            margin-top: auto;
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark footer {
            background: rgba(0, 0, 0, 0.25);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading {
            text-align: center;
            color: var(--text-light);
            padding: 30px;
            font-size: 1.2rem;
        }

        body.dark .loading {
            color: var(--text-dark);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 101;
        }

        body.dark .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-dark);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }

        body.dark .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .level-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .level-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 16px 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark .level-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .level-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        body.dark .level-button:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .level-button i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        body.dark .stat-card {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            color: white;
        }

        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--info-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 100;
            opacity: 0;
            transform: translateY(20px);
        }

        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .back-to-top:hover {
            background: #2563eb;
            transform: translateY(-3px);
        }

        body.dark .back-to-top:hover {
            background: #3b82f6;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.6rem;
            }
            
            .section {
                padding: 20px;
                margin: 15px;
                width: calc(100% - 30px);
            }
            
            .button {
                padding: 14px 20px;
                font-size: 0.95rem;
            }
            
            .flashcard {
                padding: 16px;
            }
            
            .quiz-option {
                padding: 12px 15px;
            }
            
            .search-input, .quiz-input {
                padding: 12px 16px 12px 40px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </button>

    <button class="back-to-top" id="backToTop" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <header>
        <h1>Tegy S: Обучение по направлениям</h1>
        <div class="user-greeting" id="user-greeting">Добро пожаловать!</div>
    </header>
    
    <div id="main-menu" class="section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-progress">0</div>
                <div class="stat-label">Заданий</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="streak-display">0</div>
                <div class="stat-label">Серия дней</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="favorites-count">0</div>
                <div class="stat-label">Избранное</div>
            </div>
        </div>
        <p>Выберите направление для обучения:</p>
        <button class="button" onclick="showSection('english')"><i class="fas fa-book"></i> Английский язык</button>
        <button class="button" onclick="showSection('math')"><i class="fas fa-calculator"></i> Математика</button>
        <button class="button" onclick="showSection('history')"><i class="fas fa-history"></i> История</button>
        <button class="button" onclick="showSection('programming')"><i class="fas fa-code"></i> Программирование</button>
        <button class="button" onclick="showSection('profile')"><i class="fas fa-user"></i> Профиль</button>
        <button class="button" onclick="showSection('about')"><i class="fas fa-info-circle"></i> О нас</button>
    </div>

    <!-- English Section -->
    <div id="english-section" class="section" style="display: none;">
        <h2>Уроки английского языка</h2>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-english" placeholder="Поиск по словам..." oninput="debouncedSearchFlashcards('english')">
        </div>
        <div id="daily-challenge-english" class="daily-challenge" style="display: none;">
            <h3>Ежедневный вызов</h3>
            <p id="daily-word"></p>
            <div class="quiz-input-container">
                <input type="text" id="daily-input" class="quiz-input" placeholder="Перевод">
                <button class="button" onclick="checkDaily('english')" style="width: auto; padding: 14px 20px;"><i class="fas fa-check"></i></button>
            </div>
            <p id="daily-result" class="result"></p>
        </div>
        <p>Выберите уровень:</p>
        <div class="level-buttons">
            <button class="level-button" onclick="showLevel('english', 'beginner')"><i class="fas fa-star"></i> Beginner</button>
            <button class="level-button" onclick="showLevel('english', 'intermediate')"><i class="fas fa-star-half-alt"></i> Intermediate</button>
            <button class="level-button" onclick="showLevel('english', 'advanced')"><i class="fas fa-star"></i> Advanced</button>
        </div>
        <div id="english-beginner-level" class="level-section">
            <h3>Beginner: Основные слова и фразы</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-english-beginner">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-english-beginner" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-english-beginner"></div>
            <div id="quizzes-english-beginner" class="quiz-container"></div>
            <div id="award-english-beginner" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('english', 'beginner')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-english-beginner" onclick="showLevel('english', 'intermediate')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('english')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="english-intermediate-level" class="level-section">
            <h3>Intermediate: Фразы и грамматика</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-english-intermediate">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-english-intermediate" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-english-intermediate"></div>
            <div id="quizzes-english-intermediate" class="quiz-container"></div>
            <div id="award-english-intermediate" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('english', 'intermediate')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-english-intermediate" onclick="showLevel('english', 'advanced')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('english')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="english-advanced-level" class="level-section">
            <h3>Advanced: Идиомы и сложные конструкции</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-english-advanced">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-english-advanced" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-english-advanced"></div>
            <div id="quizzes-english-advanced" class="quiz-container"></div>
            <div id="award-english-advanced" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('english', 'advanced')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-english-advanced" onclick="showMainMenu()"><i class="fas fa-flag-checkered"></i> Завершить</button>
            <button class="button" onclick="hideLevels('english')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div class="favorites-list" id="favorites-english">
            <h3>Избранные карточки</h3>
        </div>
    </div>

    <!-- Math Section -->
    <div id="math-section" class="section" style="display: none;">
        <h2>Уроки математики</h2>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-math" placeholder="Поиск по темам..." oninput="debouncedSearchFlashcards('math')">
        </div>
        <div id="daily-challenge-math" class="daily-challenge" style="display: none;">
            <h3>Ежедневный вызов</h3>
            <p id="daily-math-question"></p>
            <div class="quiz-input-container">
                <input type="text" id="daily-math-input" class="quiz-input" placeholder="Ответ">
                <button class="button" onclick="checkDaily('math')" style="width: auto; padding: 14px 20px;"><i class="fas fa-check"></i></button>
            </div>
            <p id="daily-math-result" class="result"></p>
        </div>
        <p>Выберите уровень:</p>
        <div class="level-buttons">
            <button class="level-button" onclick="showLevel('math', 'beginner')"><i class="fas fa-star"></i> Beginner</button>
            <button class="level-button" onclick="showLevel('math', 'intermediate')"><i class="fas fa-star-half-alt"></i> Intermediate</button>
            <button class="level-button" onclick="showLevel('math', 'advanced')"><i class="fas fa-star"></i> Advanced</button>
        </div>
        <div id="math-beginner-level" class="level-section">
            <h3>Beginner: Основы арифметики</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-math-beginner">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-math-beginner" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-math-beginner"></div>
            <div id="quizzes-math-beginner" class="quiz-container"></div>
            <div id="award-math-beginner" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('math', 'beginner')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-math-beginner" onclick="showLevel('math', 'intermediate')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('math')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="math-intermediate-level" class="level-section">
            <h3>Intermediate: Геометрия и алгебра</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-math-intermediate">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-math-intermediate" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-math-intermediate"></div>
            <div id="quizzes-math-intermediate" class="quiz-container"></div>
            <div id="award-math-intermediate" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('math', 'intermediate')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-math-intermediate" onclick="showLevel('math', 'advanced')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('math')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="math-advanced-level" class="level-section">
            <h3>Advanced: Калькулюс и статистика</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-math-advanced">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-math-advanced" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-math-advanced"></div>
            <div id="quizzes-math-advanced" class="quiz-container"></div>
            <div id="award-math-advanced" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('math', 'advanced')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-math-advanced" onclick="showMainMenu()"><i class="fas fa-flag-checkered"></i> Завершить</button>
            <button class="button" onclick="hideLevels('math')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div class="favorites-list" id="favorites-math">
            <h3>Избранные карточки</h3>
        </div>
    </div>

    <!-- History Section -->
    <div id="history-section" class="section" style="display: none;">
        <h2>Уроки истории</h2>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-history" placeholder="Поиск по событиям..." oninput="debouncedSearchFlashcards('history')">
        </div>
        <div id="daily-challenge-history" class="daily-challenge" style="display: none;">
            <h3>Ежедневный вызов</h3>
            <p id="daily-history-question"></p>
            <div class="quiz-input-container">
                <input type="text" id="daily-history-input" class="quiz-input" placeholder="Ответ">
                <button class="button" onclick="checkDaily('history')" style="width: auto; padding: 14px 20px;"><i class="fas fa-check"></i></button>
            </div>
            <p id="daily-history-result" class="result"></p>
        </div>
        <p>Выберите уровень:</p>
        <div class="level-buttons">
            <button class="level-button" onclick="showLevel('history', 'beginner')"><i class="fas fa-star"></i> Beginner</button>
            <button class="level-button" onclick="showLevel('history', 'intermediate')"><i class="fas fa-star-half-alt"></i> Intermediate</button>
            <button class="level-button" onclick="showLevel('history', 'advanced')"><i class="fas fa-star"></i> Advanced</button>
        </div>
        <div id="history-beginner-level" class="level-section">
            <h3>Beginner: Древний мир</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-history-beginner">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-history-beginner" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-history-beginner"></div>
            <div id="quizzes-history-beginner" class="quiz-container"></div>
            <div id="award-history-beginner" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('history', 'beginner')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-history-beginner" onclick="showLevel('history', 'intermediate')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('history')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="history-intermediate-level" class="level-section">
            <h3>Intermediate: Средневековье</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-history-intermediate">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-history-intermediate" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-history-intermediate"></div>
            <div id="quizzes-history-intermediate" class="quiz-container"></div>
            <div id="award-history-intermediate" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('history', 'intermediate')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-history-intermediate" onclick="showLevel('history', 'advanced')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('history')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="history-advanced-level" class="level-section">
            <h3>Advanced: Современная история</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-history-advanced">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-history-advanced" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-history-advanced"></div>
            <div id="quizzes-history-advanced" class="quiz-container"></div>
            <div id="award-history-advanced" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('history', 'advanced')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-history-advanced" onclick="showMainMenu()"><i class="fas fa-flag-checkered"></i> Завершить</button>
            <button class="button" onclick="hideLevels('history')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div class="favorites-list" id="favorites-history">
            <h3>Избранные карточки</h3>
        </div>
    </div>

    <!-- Programming Section -->
    <div id="programming-section" class="section" style="display: none;">
        <h2>Уроки программирования</h2>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-programming" placeholder="Поиск по терминам..." oninput="debouncedSearchFlashcards('programming')">
        </div>
        <div id="daily-challenge-programming" class="daily-challenge" style="display: none;">
            <h3>Ежедневный вызов</h3>
            <p id="daily-programming-question"></p>
            <div class="quiz-input-container">
                <input type="text" id="daily-programming-input" class="quiz-input" placeholder="Ответ">
                <button class="button" onclick="checkDaily('programming')" style="width: auto; padding: 14px 20px;"><i class="fas fa-check"></i></button>
            </div>
            <p id="daily-programming-result" class="result"></p>
        </div>
        <p>Выберите уровень:</p>
        <div class="level-buttons">
            <button class="level-button" onclick="showLevel('programming', 'beginner')"><i class="fas fa-star"></i> Beginner</button>
            <button class="level-button" onclick="showLevel('programming', 'intermediate')"><i class="fas fa-star-half-alt"></i> Intermediate</button>
            <button class="level-button" onclick="showLevel('programming', 'advanced')"><i class="fas fa-star"></i> Advanced</button>
        </div>
        <div id="programming-beginner-level" class="level-section">
            <h3>Beginner: Основы</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-programming-beginner">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-programming-beginner" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-programming-beginner"></div>
            <div id="quizzes-programming-beginner" class="quiz-container"></div>
            <div id="award-programming-beginner" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('programming', 'beginner')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-programming-beginner" onclick="showLevel('programming', 'intermediate')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('programming')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="programming-intermediate-level" class="level-section">
            <h3>Intermediate: Циклы и условия</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-programming-intermediate">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-programming-intermediate" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-programming-intermediate"></div>
            <div id="quizzes-programming-intermediate" class="quiz-container"></div>
            <div id="award-programming-intermediate" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('programming', 'intermediate')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-programming-intermediate" onclick="showLevel('programming', 'advanced')"><i class="fas fa-arrow-right"></i> Следующий уровень</button>
            <button class="button" onclick="hideLevels('programming')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div id="programming-advanced-level" class="level-section">
            <h3>Advanced: OOP и алгоритмы</h3>
            <div class="progress-container">
                <div class="progress-header">
                    <span>Прогресс</span>
                    <span id="progress-text-programming-advanced">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-programming-advanced" style="width: 0%;"></div></div>
            </div>
            <div id="flashcards-programming-advanced"></div>
            <div id="quizzes-programming-advanced" class="quiz-container"></div>
            <div id="award-programming-advanced" style="display: none;"><span class="award">🏆 Уровень пройден!</span></div>
            <button class="button" onclick="repeatLevel('programming', 'advanced')"><i class="fas fa-redo"></i> Повторить уровень</button>
            <button class="button" style="display: none;" id="next-programming-advanced" onclick="showMainMenu()"><i class="fas fa-flag-checkered"></i> Завершить</button>
            <button class="button" onclick="hideLevels('programming')"><i class="fas fa-arrow-left"></i> Вернуться к уровням</button>
        </div>
        <div class="favorites-list" id="favorites-programming">
            <h3>Избранные карточки</h3>
        </div>
    </div>

    <div id="profile-section" class="section profile-section" style="display: none;">
        <h2>Ваш профиль</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="profile-streak">0</div>
                <div class="stat-label">Серия дней</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="profile-favorites">0</div>
                <div class="stat-label">Избранное</div>
            </div>
        </div>
        <p>Прогресс по предметам:</p>
        <ul id="profile-progress"></ul>
        <p>Значки:</p>
        <div id="profile-badges"></div>
        <button class="button" onclick="shareProgress()"><i class="fas fa-share"></i> Поделиться прогрессом</button>
        <button class="button" onclick="showMainMenu()"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <div id="about-section" class="section" style="display: none;">
        <h2>О нас</h2>
        <p class="about-text">Tegcompany — инновационная компания, основанная в Республике Беларусь Юркевичем Артёмом Игоревичем. С момента своего основания Tegcompany сосредоточилась на разработке интеллектуальных решений, начав с создания первых чат-ботов с элементами искусственного интеллекта — Tegych P и Beeprav P. Эти проекты стали отправной точкой в развитии компании, заложив основу для будущих технологических инициатив.</p>
        <button class="button" onclick="showMainMenu()"><i class="fas fa-arrow-left"></i> Назад</button>
    </div>

    <footer>
        &copy; 2025 Tegcompany. Все права защищены.
    </footer>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        const initData = tg.initDataUnsafe;
        if (!initData || !initData.user) {
            document.body.innerHTML = '<p style="color: white; text-align: center; margin-top: 50px;">Доступ только через Telegram!</p>';
        } else {
            tg.ready();
            tg.expand();
        }

        // Полные данные уроков
        const subjects = {
            english: {
                beginner: {
                    flashcards: [
                        { word: 'Apple', translation: 'Яблоко', example: 'I eat an apple every day.', img: 'https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=300', fact: 'Apple — это также компания, основанная Стивом Джобсом.' },
                        { word: 'Banana', translation: 'Банан', example: 'Bananas are yellow.', img: 'https://images.unsplash.com/photo-1571771894821-ce9b6c276b63?w=300', fact: 'Бананы — это ягоды!' },
                        { word: 'Car', translation: 'Машина', example: 'I drive a car.', img: 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?w=300', fact: 'Первая машина была изобретена в 1886 году.' },
                        { word: 'Dog', translation: 'Собака', example: 'The dog barks.', img: 'https://images.unsplash.com/photo-1534361960057-1988672b3f2f?w=300', fact: 'Собаки — лучшие друзья человека.' },
                        { word: 'House', translation: 'Дом', example: 'This is my house.', img: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=300', fact: 'Средний дом имеет 3 комнаты.' }
                    ],
                    quizzes: [
                        { question: 'Переведи "Dog"', answer: 'собака', options: ['кошка', 'собака', 'птица', 'рыба'] },
                        { question: 'Переведи "Thank you"', answer: 'спасибо', options: ['привет', 'спасибо', 'пока', 'да'] },
                        { question: 'Переведи "Hello"', answer: 'привет', options: ['пока', 'привет', 'да', 'нет'] },
                        { question: 'Переведи "Water"', answer: 'вода', options: ['огонь', 'вода', 'земля', 'воздух'] },
                        { question: 'Переведи "Book"', answer: 'книга', options: ['фильм', 'книга', 'песня', 'игра'] }
                    ],
                    video: 'dQw4w9WgXcQ'
                },
                intermediate: {
                    flashcards: [
                        { word: 'Meeting', translation: 'Встреча', example: 'We have a meeting at 10 AM.', img: 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=300', fact: 'Meetings can be virtual now.' },
                        { word: 'Computer', translation: 'Компьютер', example: 'I use a computer for work.', img: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300', fact: 'First computer was ENIAC in 1945.' },
                        { word: 'Friend', translation: 'Друг', example: 'She is my best friend.', img: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300', fact: 'Friendships last longer than romance.' },
                        { word: 'Travel', translation: 'Путешествие', example: 'I love to travel abroad.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Travel broadens the mind.' },
                        { word: 'Music', translation: 'Музыка', example: 'I listen to music every day.', img: 'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=300', fact: 'Music therapy heals the soul.' }
                    ],
                    quizzes: [
                        { question: 'Переведи "Meeting"', answer: 'встреча', options: ['праздник', 'встреча', 'работа', 'еда'] },
                        { question: 'Переведи "Computer"', answer: 'компьютер', options: ['телефон', 'компьютер', 'книга', 'машина'] },
                        { question: 'Переведи "Friend"', answer: 'друг', options: ['враг', 'друг', 'семья', 'учитель'] },
                        { question: 'Переведи "Travel"', answer: 'путешествие', options: ['работа', 'путешествие', 'сон', 'еда'] },
                        { question: 'Переведи "Music"', answer: 'музыка', options: ['танец', 'музыка', 'спорт', 'искусство'] }
                    ],
                    video: 'M7lc1UVf-VE'
                },
                advanced: {
                    flashcards: [
                        { word: 'Idiom: Break a leg', translation: 'Удачи!', example: 'Break a leg on your exam!', img: 'https://images.unsplash.com/photo-1544965888-5e92e1e9e9e1?w=300', fact: 'This idiom comes from theater.' },
                        { word: 'Passive voice', translation: 'Пассивный залог', example: 'The book was read by me.', img: 'https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=300', fact: 'Used for emphasis on action.' },
                        { word: 'Metaphor', translation: 'Метафора', example: 'Time is money.', img: 'https://images.unsplash.com/photo-1549497538-da9d8ec99e97?w=300', fact: 'A figure of speech without "like".' },
                        { word: 'Conditional', translation: 'Условное наклонение', example: 'If it rains, I will stay home.', img: 'https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?w=300', fact: 'Has zero, first, second, third types.' },
                        { word: 'Phrasal verb: Give up', translation: 'Сдаваться', example: 'Don\'t give up on your dreams.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Common in English speech.' }
                    ],
                    quizzes: [
                        { question: 'Что значит "Break a leg"?', answer: 'удачи', options: ['сломать ногу', 'удачи', 'бежать', 'падать'] },
                        { question: 'Пример пассивного залога?', answer: 'Книга была прочитана', options: ['Я читаю книгу', 'Книга была прочитана', 'Книга читает меня', 'Я прочитал книгу'] },
                        { question: 'Что такое метафора?', answer: 'фигура речи', options: ['еда', 'фигура речи', 'цвет', 'число'] },
                        { question: 'Пример условного?', answer: 'если дождь, останусь дома', options: ['Я иду домой', 'если дождь, останусь дома', 'Дом мокрый', 'Дождь идет'] },
                        { question: 'Give up значит?', answer: 'сдаваться', options: ['давать вверх', 'сдаваться', 'получать', 'брать'] }
                    ],
                    video: '9bZkp7q19f0'
                }
            },
            math: {
                beginner: {
                    flashcards: [
                        { term: 'Addition', explanation: 'Сложение чисел', example: '2 + 3 = 5', img: 'https://images.unsplash.com/photo-1635372720855-3d7777c4ff21?w=300', fact: 'Сложение коммутативно: a + b = b + a' },
                        { term: 'Subtraction', explanation: 'Вычитание', example: '5 - 2 = 3', img: 'https://images.unsplash.com/photo-1540979388789-6cee28a1cdc9?w=300', fact: 'Вычитание не коммутативно.' },
                        { term: 'Multiplication', explanation: 'Умножение', example: '4 * 2 = 8', img: 'https://images.unsplash.com/photo-1585964481499-2be451621bb5?w=300', fact: 'Умножение на 0 = 0.' },
                        { term: 'Division', explanation: 'Деление', example: '6 / 2 = 3', img: 'https://images.unsplash.com/photo-1567492031773-4f5f8e9c996b?w=300', fact: 'Деление на 0 невозможно.' },
                        { term: 'Number', explanation: 'Число', example: '5 is a prime number.', img: 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=300', fact: 'Числа бывают натуральными, целыми и т.д.' }
                    ],
                    quizzes: [
                        { question: '2 + 2 = ?', answer: '4', options: ['3', '4', '5', '6'] },
                        { question: '5 - 3 = ?', answer: '2', options: ['1', '2', '3', '4'] },
                        { question: '4 * 3 = ?', answer: '12', options: ['10', '12', '15', '8'] },
                        { question: '8 / 2 = ?', answer: '4', options: ['3', '4', '5', '2'] },
                        { question: 'Что такое 1 + 1?', answer: '2', options: ['1', '2', '3', '0'] }
                    ],
                    video: 'M7lc1UVf-VE'
                },
                intermediate: {
                    flashcards: [
                        { term: 'Equation', explanation: 'Уравнение', example: 'x + 2 = 5, x=3', img: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=300', fact: 'Решение уравнения — найти x.' },
                        { term: 'Triangle', explanation: 'Треугольник', example: 'Сумма углов = 180°', img: 'https://images.unsplash.com/photo-1570549717069-33bed1ebafed?w=300', fact: 'Виды: равносторонний, прямоугольный.' },
                        { term: 'Variable', explanation: 'Переменная', example: 'Let x = 10', img: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300', fact: 'Используется в алгебре.' },
                        { term: 'Area', explanation: 'Площадь', example: 'Площадь прямоугольника = длина * ширина', img: 'https://images.unsplash.com/photo-1549576490-b0b4831e8f1f?w=300', fact: 'Для круга: πr².' },
                        { term: 'Fraction', explanation: 'Дробь', example: '1/2 + 1/2 = 1', img: 'https://images.unsplash.com/photo-1581287053821-6927a274775e?w=300', fact: 'Дроби упрощаются.' }
                    ],
                    quizzes: [
                        { question: 'Решить x + 3 = 7', answer: '4', options: ['3', '4', '5', '10'] },
                        { question: 'Сумма углов треугольника?', answer: '180', options: ['90', '180', '360', '270'] },
                        { question: 'Площадь 2x3 прямоугольника?', answer: '6', options: ['5', '6', '8', '1'] },
                        { question: '1/2 * 2 = ?', answer: '1', options: ['0.5', '1', '2', '0'] },
                        { question: 'Что такое переменная?', answer: 'x или y', options: ['число', 'x или y', 'операция', 'фигура'] }
                    ],
                    video: 'dQw4w9WgXcQ'
                },
                advanced: {
                    flashcards: [
                        { term: 'Derivative', explanation: 'Производная', example: 'd/dx (x²) = 2x', img: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300', fact: 'Используется в физике.' },
                        { term: 'Integral', explanation: 'Интеграл', example: '∫x dx = (1/2)x²', img: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=300', fact: 'Обратна производной.' },
                        { term: 'Mean', explanation: 'Среднее', example: 'Среднее [1,2,3] = 2', img: 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=300', fact: 'В статистике.' },
                        { term: 'Probability', explanation: 'Вероятность', example: 'P(heads) = 0.5', img: 'https://images.unsplash.com/photo-1550751827-4f5f8e9c996b?w=300', fact: 'От 0 до 1.' },
                        { term: 'Limit', explanation: 'Предел', example: 'lim x→0 sin(x)/x = 1', img: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300', fact: 'Основы калькулюса.' }
                    ],
                    quizzes: [
                        { question: 'Производная x²?', answer: '2x', options: ['x', '2x', 'x²', '0'] },
                        { question: 'Интеграл x?', answer: '(1/2)x²', options: ['x', '(1/2)x²', 'x³', '2x'] },
                        { question: 'Среднее [1,3,5]?', answer: '3', options: ['2', '3', '4', '9'] },
                        { question: 'Вероятность монеты?', answer: '0.5', options: ['0', '0.5', '1', '2'] },
                        { question: 'Предел sin(x)/x при 0?', answer: '1', options: ['0', '1', '∞', 'sin(0)'] }
                    ],
                    video: '9bZkp7q19f0'
                }
            },
            history: {
                beginner: {
                    flashcards: [
                        { event: 'Ancient Egypt', explanation: 'Цивилизация фараонов', example: 'Построили пирамиды', img: 'https://images.unsplash.com/photo-1506354660007-9d744c9d0c0c?w=300', fact: 'Пирамиды стоят более 4500 лет.' },
                        { event: 'Roman Empire', explanation: 'Империя Цезаря', example: 'Строили акведуки', img: 'https://images.unsplash.com/photo-1510414842594-a61c69b5ae57?w=300', fact: 'Длилась 500 лет.' },
                        { event: 'Greek Philosophy', explanation: 'Философия Сократа', example: 'Демократия в Афинах', img: 'https://images.unsplash.com/photo-1578632354571-0de2c52e5563?w=300', fact: 'Сократ: "Я знаю, что ничего не знаю".' },
                        { event: 'Stone Age', explanation: 'Каменный век', example: 'Орудия из камня', img: 'https://images.unsplash.com/photo-1570549717069-33bed1ebafed?w=300', fact: 'Длился миллионы лет.' },
                        { event: 'Invention of Wheel', explanation: 'Изобретение колеса', example: 'Около 3500 г. до н.э.', img: 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?w=300', fact: 'Изменло транспорт.' }
                    ],
                    quizzes: [
                        { question: 'Кто построил пирамиды?', answer: 'египтяне', options: ['римляне', 'греки', 'египтяне', 'майя'] },
                        { question: 'Столица Римской империи?', answer: 'рома', options: ['атены', 'рома', 'спарта', 'египет'] },
                        { question: 'Философ: "Познай себя"?', answer: 'сократ', options: ['платон', 'сократ', 'аристотель', 'гераклит'] },
                        { question: 'Каменный век — это?', answer: 'древний период', options: ['будущее', 'древний период', 'средневековье', 'современность'] },
                        { question: 'Когда изобрели колесо?', answer: '3500 до н.э.', options: ['1000 н.э.', '3500 до н.э.', '500 н.э.', '0'] }
                    ],
                    video: '9bZkp7q19f0'
                },
                intermediate: {
                    flashcards: [
                        { event: 'Middle Ages', explanation: 'Средневековье', example: 'Рыцари и замки', img: 'https://images.unsplash.com/photo-1510414842594-a61c69b5ae57?w=300', fact: 'Длилось 1000 лет.' },
                        { event: 'Renaissance', explanation: 'Возрождение', example: 'Да Винчи и Микеланджело', img: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300', fact: 'Началось в Италии.' },
                        { event: 'Crusades', explanation: 'Крестовые походы', example: '1095–1291 гг.', img: 'https://images.unsplash.com/photo-1578632354571-0de2c52e5563?w=300', fact: 'За Святую землю.' },
                        { event: 'Black Death', explanation: 'Чёрная смерть', example: 'Чума 1347 г.', img: 'https://images.unsplash.com/photo-1550751827-4f5f8e9c996b?w=300', fact: 'Убила 30–60% Европы.' },
                        { event: 'Feudalism', explanation: 'Феодализм', example: 'Короли, вассалы, крестьяне', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Система земель.' }
                    ],
                    quizzes: [
                        { question: 'Период рыцарей?', answer: 'средневековье', options: ['древний мир', 'средневековье', 'новое время', 'будущее'] },
                        { question: 'Художник Ренессанса?', answer: 'да винчи', options: ['сократ', 'да винчи', 'цезарь', 'колумб'] },
                        { question: 'Крестовые походы за?', answer: 'святую землю', options: ['золото', 'святую землю', 'территории', 'мир'] },
                        { question: 'Чума 1347?', answer: 'чёрная смерть', options: ['пандемия', 'чёрная смерть', 'война', 'голод'] },
                        { question: 'Феодализм — это?', answer: 'система вассалов', options: ['демократия', 'система вассалов', 'капитализм', 'коммунизм'] }
                    ],
                    video: 'M7lc1UVf-VE'
                },
                advanced: {
                    flashcards: [
                        { event: 'World War I', explanation: 'Первая мировая война', example: '1914–1918 гг.', img: 'https://images.unsplash.com/photo-1567492031773-4f5f8e9c996b?w=300', fact: 'Убила 16 млн человек.' },
                        { event: 'Industrial Revolution', explanation: 'Промышленная революция', example: '1760–1840 гг.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Машины изменили мир.' },
                        { event: 'Cold War', explanation: 'Холодная война', example: '1947–1991 гг.', img: 'https://images.unsplash.com/photo-1540979388789-6cee28a1cdc9?w=300', fact: 'США vs СССР.' },
                        { event: 'Fall of Berlin Wall', explanation: 'Падение Берлинской стены', example: '1989 г.', img: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300', fact: 'Конец холодной войны.' },
                        { event: 'Digital Age', explanation: 'Цифровая эра', example: 'Интернет с 1990-х', img: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300', fact: 'Смартфоны везде.' }
                    ],
                    quizzes: [
                        { question: 'Первая мировая — годы?', answer: '1914-1918', options: ['1939-1945', '1914-1918', '1812', '1492'] },
                        { question: 'Промышленная революция — когда?', answer: '1760-1840', options: ['1500', '1760-1840', '2000', '1900'] },
                        { question: 'Холодная война: кто vs кто?', answer: 'ссср vs сша', options: ['англии vs франции', 'ссср vs сша', 'египта vs греции', 'рим vs греция'] },
                        { question: 'Падение стены — 1989?', answer: 'берлинской', options: ['китайской', 'берлинской', 'римской', 'египетской'] },
                        { question: 'Цифровая эра началась с?', answer: 'интернета', options: ['колеса', 'интернета', 'паровоза', 'книги'] }
                    ],
                    video: 'dQw4w9WgXcQ'
                }
            },
            programming: {
                beginner: {
                    flashcards: [
                        { term: 'Variable', explanation: 'Переменная', example: 'let x = 5;', img: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300', fact: 'Хранит данные в памяти.' },
                        { term: 'Function', explanation: 'Функция', example: 'function hello() { console.log("Hi"); }', img: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300', fact: 'Блок кода для повторного использования.' },
                        { term: 'String', explanation: 'Строка', example: '"Hello World"', img: 'https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=300', fact: 'Текст в кавычках.' },
                        { term: 'Number', explanation: 'Число', example: '42 или 3.14', img: 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=300', fact: 'Целое или дробное.' },
                        { term: 'Console', explanation: 'Консоль', example: 'console.log("Debug");', img: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=300', fact: 'Для вывода сообщений.' }
                    ],
                    quizzes: [
                        { question: 'Что такое переменная?', answer: 'хранит данные', options: ['функция', 'хранит данные', 'строка', 'число'] },
                        { question: 'Пример функции?', answer: 'function()', options: ['let x=5', 'function()', '"text"', '42'] },
                        { question: 'Строка в JS?', answer: '"hello"', options: ['let', '"hello"', 'function', 'console'] },
                        { question: 'Число: 3.14 — это?', answer: 'дробное', options: ['строка', 'дробное', 'функция', 'консоль'] },
                        { question: 'console.log для?', answer: 'вывода', options: ['ввода', 'вывода', 'хранения', 'вычисления'] }
                    ],
                    video: 'dQw4w9WgXcQ'
                },
                intermediate: {
                    flashcards: [
                        { term: 'Loop: For', explanation: 'Цикл for', example: 'for(let i=0; i<5; i++) { ... }', img: 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=300', fact: 'Для повторений известного количества.' },
                        { term: 'If Statement', explanation: 'Условие if', example: 'if(x > 0) { ... }', img: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300', fact: 'Проверяет условие.' },
                        { term: 'Array', explanation: 'Массив', example: '[1,2,3]', img: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=300', fact: 'Список элементов.' },
                        { term: 'While Loop', explanation: 'Цикл while', example: 'while(condition) { ... }', img: 'https://images.unsplash.com/photo-1578632354571-0de2c52e5563?w=300', fact: 'Повторяет пока условие true.' },
                        { term: 'Boolean', explanation: 'Логический тип', example: 'true или false', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Для условий.' }
                    ],
                    quizzes: [
                        { question: 'Цикл for для?', answer: 'повторений', options: ['условий', 'повторений', 'хранения', 'текста'] },
                        { question: 'If проверяет?', answer: 'условие', options: ['число', 'условие', 'строку', 'массив'] },
                        { question: 'Массив: [1,2] — это?', answer: 'список', options: ['число', 'список', 'функция', 'строка'] },
                        { question: 'While повторяет пока?', answer: 'true', options: ['false', 'true', '0', '"stop"'] },
                        { question: 'Boolean: true/false — для?', answer: 'логики', options: ['математики', 'логики', 'текста', 'графики'] }
                    ],
                    video: 'M7lc1UVf-VE'
                },
                advanced: {
                    flashcards: [
                        { term: 'Class', explanation: 'Класс (ООП)', example: 'class Dog { bark() { ... } }', img: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300', fact: 'Шаблон для объектов.' },
                        { term: 'Inheritance', explanation: 'Наследование', example: 'class Puppy extends Dog { ... }', img: 'https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?w=300', fact: 'Передача свойств.' },
                        { term: 'Algorithm: Sort', explanation: 'Алгоритм сортировки', example: 'Bubble sort: сравни и поменяй', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'O(n²) сложность.' },
                        { term: 'Recursion', explanation: 'Рекурсия', example: 'function factorial(n) { if(n<=1) return 1; return n * factorial(n-1); }', img: 'https://images.unsplash.com/photo-1540979388789-6cee28a1cdc9?w=300', fact: 'Функция вызывает себя.' },
                        { term: 'API', explanation: 'Интерфейс программирования', example: 'fetch("https://api.example.com")', img: 'https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=300', fact: 'Для связи приложений.' }
                    ],
                    quizzes: [
                        { question: 'Класс в OOP?', answer: 'шаблон', options: ['функция', 'шаблон', 'массив', 'строка'] },
                        { question: 'Наследование: extends?', answer: 'да', options: ['нет', 'да', 'только числа', 'только строки'] },
                        { question: 'Bubble sort — это?', answer: 'сортировка', options: ['поиск', 'сортировка', 'хранение', 'вывод'] },
                        { question: 'Рекурсия: функция?', answer: 'вызывает себя', options: ['останавливается', 'вызывает себя', 'игнорирует', 'удаляет'] },
                        { question: 'API для?', answer: 'связи', options: ['вычислений', 'связи', 'графики', 'текста'] }
                    ],
                    video: '9bZkp7q19f0'
                }
            }
        };

        // Хранение данных
        let progress = JSON.parse(localStorage.getItem('tegyProgress')) || {};
        let favorites = JSON.parse(localStorage.getItem('tegyFavorites')) || {};
        let streak = parseInt(localStorage.getItem('tegyStreak')) || 0;
        let lastDaily = localStorage.getItem('tegyLastDaily') || new Date().toDateString();
        let searchTimeout;

        // Функции
        function generateFlashcards(subject, level) {
            const container = document.getElementById(`flashcards-${subject}-${level}`);
            if (!container) return;
            container.innerHTML = '<div class="loading">Загрузка карточек...</div>';
            setTimeout(() => {
                container.innerHTML = '';
                subjects[subject][level].flashcards.forEach((card, index) => {
                    const div = document.createElement('div');
                    div.className = 'flashcard';
                    div.dataset.key = `${subject}-${level}-${index}`;
                    const term = card.word || card.term || card.event;
                    const expl = card.translation || card.explanation;
                    div.innerHTML = `
                        <button class="favorite-btn ${favorites[div.dataset.key] ? 'favorited' : ''}" onclick="toggleFavorite('${subject}', '${level}', ${index})">❤️</button>
                        <img src="${card.img}" alt="${term}" loading="lazy">
                        <p><strong>${card.word ? 'Слово' : card.term ? 'Термин' : 'Событие'}:</strong> ${term}</p>
                        <p><strong>${card.translation ? 'Перевод' : 'Объяснение'}:</strong> ${expl}</p>
                        <p><strong>Пример:</strong> ${card.example}</p>
                        <p><strong>Интересный факт:</strong> ${card.fact}</p>
                        ${card.word ? `<button class="speak-btn" onclick="speakText('${term}')"><i class="fas fa-volume-up"></i></button>` : ''}
                    `;
                    container.appendChild(div);
                });
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${subjects[subject][level].video}`;
                iframe.frameBorder = '0';
                iframe.allowFullscreen = true;
                iframe.loading = 'lazy';
                container.appendChild(iframe);
            }, 500);
        }

        function generateQuizzes(subject, level) {
            const container = document.getElementById(`quizzes-${subject}-${level}`);
            if (!container) return;
            container.innerHTML = '<h3>Квиз</h3>';
            const quizzes = subjects[subject][level].quizzes;
            const shuffled = [...quizzes].sort(() => 0.5 - Math.random());
            shuffled.forEach((q, index) => {
                const id = `${subject}-${level}-q${index + 1}`;
                let optionsHtml = q.options.map(opt => 
                    `<div class="quiz-option" onclick="checkQuizOption('${id}', '${q.answer}', '${opt}', '${subject}', '${level}', this)">${opt}</div>`
                ).join('');
                container.innerHTML += `
                    <p class="quiz-question">Вопрос ${index + 1}: ${q.question}</p>
                    <div class="quiz-options">${optionsHtml}</div>
                    <p id="result-${id}" class="result"></p>
                `;
            });
        }

        function showLevel(subject, level) {
            hideLevels(subject);
            const section = document.getElementById(`${subject}-${level}-level`);
            if (section) section.style.display = 'block';
            generateFlashcards(subject, level);
            generateQuizzes(subject, level);
            updateProgress(subject, level);
            showDailyChallenge(subject);
            window.scrollTo(0, 0);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('tegyTheme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
            const targetSection = document.getElementById(`${sectionId}-section`);
            if (targetSection) targetSection.style.display = 'block';
            if (sectionId !== 'profile' && sectionId !== 'about') hideLevels(sectionId);
            if (sectionId === 'profile') updateProfile();
            if (subjects[sectionId]) updateFavorites(sectionId);
            window.scrollTo(0, 0);
        }

        function showMainMenu() {
            document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
            document.getElementById('main-menu').style.display = 'block';
            checkStreak();
            updateMainMenuStats();
        }

        function hideLevels(subject) {
            document.querySelectorAll(`#${subject}-section .level-section`).forEach(sec => sec.style.display = 'none');
        }

        function repeatLevel(subject, level) {
            const key = `${subject}-${level}`;
            progress[key] = 0;
            localStorage.setItem('tegyProgress', JSON.stringify(progress));
            showLevel(subject, level);
        }

        function updateProgress(subject, level) {
            const key = `${subject}-${level}`;
            if (!progress[key]) progress[key] = 0;
            const fill = document.getElementById(`progress-${key}`);
            const text = document.getElementById(`progress-text-${key}`);
            if (!fill || !text) return;
            const quizCount = subjects[subject][level].quizzes.length;
            const percent = Math.min((progress[key] / quizCount) * 100, 100);
            fill.style.width = `${percent}%`;
            text.innerText = `${Math.round(percent)}%`;
            if (percent >= 100) {
                document.getElementById(`award-${key}`).style.display = 'block';
                document.getElementById(`next-${key}`).style.display = 'block';
                tg.showAlert('Уровень пройден! 🎉');
            }
            localStorage.setItem('tegyProgress', JSON.stringify(progress));
        }

        function debouncedSearchFlashcards(subject) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchFlashcards(subject), 300);
        }

        function searchFlashcards(subject) {
            const searchTerm = document.getElementById(`search-${subject}`).value.toLowerCase();
            document.querySelectorAll(`#${subject}-section .flashcard`).forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function checkQuizOption(quizId, correctAnswer, selected, subject, level, element) {
            const result = document.getElementById(`result-${quizId}`);
            if (!result) return;
            
            // Убираем выделение с других опций
            const allOptions = element.parentElement.querySelectorAll('.quiz-option');
            allOptions.forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Выделяем выбранную опцию
            element.classList.add('selected');
            
            const lowerSelected = selected.toLowerCase().trim();
            const lowerCorrect = correctAnswer.toLowerCase().trim();
            
            if (lowerSelected === lowerCorrect) {
                element.classList.add('correct');
                result.innerText = 'Правильно! 🎉';
                result.className = 'result correct';
                tg.HapticFeedback.impactOccurred('heavy');
                progress[`${subject}-${level}`] = (progress[`${subject}-${level}`] || 0) + 1;
                updateProgress(subject, level);
                createConfetti();
            } else {
                element.classList.add('incorrect');
                // Подсвечиваем правильный ответ
                allOptions.forEach(opt => {
                    if (opt.textContent.toLowerCase().trim() === lowerCorrect) {
                        opt.classList.add('correct');
                    }
                });
                result.innerText = `Неправильно. Правильный ответ: ${correctAnswer}`;
                result.className = 'result incorrect';
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function createConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                tg.showAlert('Произношение не поддерживается в этом браузере.');
            }
        }

        function toggleFavorite(subject, level, index) {
            const key = `${subject}-${level}-${index}`;
            favorites[key] = !favorites[key];
            localStorage.setItem('tegyFavorites', JSON.stringify(favorites));
            updateFavorites(subject);
            
            // Обновляем цвет кнопки
            event.stopPropagation();
            const btn = event.currentTarget;
            btn.classList.toggle('favorited');
        }

        function updateFavorites(subject) {
            const container = document.getElementById(`favorites-${subject}`);
            if (!container) return;
            container.innerHTML = '<h3>Избранные карточки</h3>';
            let hasFavorites = false;
            Object.keys(favorites).forEach(key => {
                if (favorites[key] && key.startsWith(subject)) {
                    hasFavorites = true;
                    const [s, l, i] = key.split('-');
                    const card = subjects[s][l].flashcards[parseInt(i)];
                    const div = document.createElement('div');
                    div.className = 'flashcard';
                    div.innerHTML = `
                        <p><strong>${card.word || card.term || card.event}</strong>: ${card.translation || card.explanation}</p>
                        <p>Пример: ${card.example}</p>
                        <button class="remove-fav" onclick="toggleFavorite('${s}', '${l}', ${i})">Удалить</button>
                    `;
                    container.appendChild(div);
                }
            });
            if (!hasFavorites) container.innerHTML += '<p>Нет избранных карточек.</p>';
        }

        function showDailyChallenge(subject) {
            const today = new Date().toDateString();
            if (lastDaily !== today) {
                streak++;
                localStorage.setItem('tegyStreak', streak.toString());
                lastDaily = today;
                localStorage.setItem('tegyLastDaily', today);
            }
            const challengeDiv = document.getElementById(`daily-challenge-${subject}`);
            if (challengeDiv) challengeDiv.style.display = 'block';
            
            let questionEl, inputEl, resultEl;
            if (subject === 'english') {
                questionEl = document.getElementById('daily-word');
                const randomCard = subjects.english.beginner.flashcards[Math.floor(Math.random() * subjects.english.beginner.flashcards.length)];
                questionEl.innerText = `Переведи "${randomCard.word}"`;
                questionEl.dataset.correct = randomCard.translation.toLowerCase();
            } else if (subject === 'math') {
                questionEl = document.getElementById('daily-math-question');
                const randomQuiz = subjects.math.beginner.quizzes[Math.floor(Math.random() * subjects.math.beginner.quizzes.length)];
                questionEl.innerText = randomQuiz.question;
                questionEl.dataset.correct = randomQuiz.answer.toLowerCase();
            } else if (subject === 'history') {
                questionEl = document.getElementById('daily-history-question');
                const randomQuiz = subjects.history.beginner.quizzes[Math.floor(Math.random() * subjects.history.beginner.quizzes.length)];
                questionEl.innerText = randomQuiz.question;
                questionEl.dataset.correct = randomQuiz.answer.toLowerCase();
            } else if (subject === 'programming') {
                questionEl = document.getElementById('daily-programming-question');
                const randomQuiz = subjects.programming.beginner.quizzes[Math.floor(Math.random() * subjects.programming.beginner.quizzes.length)];
                questionEl.innerText = randomQuiz.question;
                questionEl.dataset.correct = randomQuiz.answer.toLowerCase();
            }
            
            if (questionEl) {
                const inputId = `daily-${subject}-input` || `daily-input`;
                inputEl = document.getElementById(inputId);
                resultEl = document.getElementById(`daily-${subject}-result`) || document.getElementById('daily-result');
                if (inputEl) inputEl.value = '';
                if (resultEl) resultEl.innerText = '';
            }
        }

        function checkDaily(subject) {
            let questionEl, inputEl, resultEl;
            if (subject === 'english') {
                questionEl = document.getElementById('daily-word');
                inputEl = document.getElementById('daily-input');
                resultEl = document.getElementById('daily-result');
            } else if (subject === 'math') {
                questionEl = document.getElementById('daily-math-question');
                inputEl = document.getElementById('daily-math-input');
                resultEl = document.getElementById('daily-math-result');
            } else if (subject === 'history') {
                questionEl = document.getElementById('daily-history-question');
                inputEl = document.getElementById('daily-history-input');
                resultEl = document.getElementById('daily-history-result');
            } else if (subject === 'programming') {
                questionEl = document.getElementById('daily-programming-question');
                inputEl = document.getElementById('daily-programming-input');
                resultEl = document.getElementById('daily-programming-result');
            }
            if (!questionEl || !inputEl || !resultEl) return;
            const userAnswer = inputEl.value.toLowerCase().trim();
            const correctAnswer = questionEl.dataset.correct || '';
            if (userAnswer === correctAnswer) {
                resultEl.innerText = 'Правильно! 🎉 Стreak обновлён.';
                resultEl.className = 'result correct';
                tg.HapticFeedback.impactOccurred('heavy');
                createConfetti();
                progress[`${subject}-beginner`] = (progress[`${subject}-beginner`] || 0) + 1;
                localStorage.setItem('tegyProgress', JSON.stringify(progress));
            } else {
                resultEl.innerText = `Неправильно. Правильный ответ: ${questionEl.dataset.correct}`;
                resultEl.className = 'result incorrect';
                tg.HapticFeedback.notificationOccurred('error');
            }
            inputEl.value = '';
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastDaily !== today && lastDaily !== yesterday.toDateString()) {
                streak = 0;
                localStorage.setItem('tegyStreak', '0');
            }
            document.getElementById('streak-display').innerText = streak;
            document.getElementById('profile-streak').innerText = streak;
        }

        function updateProfile() {
            const progressList = document.getElementById('profile-progress');
            if (!progressList) return;
            progressList.innerHTML = '';
            Object.keys(subjects).forEach(subject => {
                const levels = ['beginner', 'intermediate', 'advanced'];
                levels.forEach(level => {
                    const key = `${subject}-${level}`;
                    const li = document.createElement('li');
                    const quizCount = subjects[subject][level].quizzes.length;
                    const p = progress[key] || 0;
                    li.innerText = `${subject} ${level}: ${p} / ${quizCount} (${Math.round((p / quizCount) * 100)}%)`;
                    progressList.appendChild(li);
                });
            });
            const badges = document.getElementById('profile-badges');
            if (badges) {
                badges.innerHTML = '';
                let totalProgress = Object.values(progress).reduce((a, b) => a + b, 0);
                if (totalProgress >= 10) badges.innerHTML += '<span class="badge">🥉</span>';
                if (totalProgress >= 25) badges.innerHTML += '<span class="badge">🥈</span>';
                if (totalProgress >= 50) badges.innerHTML += '<span class="badge">🥇</span>';
                if (streak >= 7) badges.innerHTML += '<span class="badge">🔥</span>';
            }
            document.getElementById('profile-streak').innerText = streak;
            document.getElementById('profile-favorites').innerText = Object.values(favorites).filter(fav => fav).length;
        }

        function shareProgress() {
            const totalProgress = Object.values(progress).reduce((a, b) => a + b, 0);
            const text = `Мой прогресс в Tegy S: ${totalProgress} заданий пройдено! Серия: ${streak} дней. Присоединяйся! 🚀`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(tg.initDataUnsafe.start_param || '')}&text=${encodeURIComponent(text)}`);
        }

        function updateMainMenuStats() {
            const totalProgress = Object.values(progress).reduce((a, b) => a + b, 0);
            const favoritesCount = Object.values(favorites).filter(fav => fav).length;
            
            document.getElementById('total-progress').innerText = totalProgress;
            document.getElementById('streak-display').innerText = streak;
            document.getElementById('favorites-count').innerText = favoritesCount;
            
            const user = initData.user;
            if (user && user.first_name) {
                document.getElementById('user-greeting').innerText = `Привет, ${user.first_name}!`;
            }
        }

        // Функции для кнопки "Наверх"
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.onscroll = function() {
            const backToTopButton = document.getElementById('backToTop');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopButton.classList.add('visible');
            } else {
                backToTopButton.classList.remove('visible');
            }
        };

        // Инициализация приложения
        function init() {
            // Восстанавливаем тему
            if (localStorage.getItem('tegyTheme') === 'dark') {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle i').className = 'fas fa-sun';
            }
            
            // Показываем главное меню
            showMainMenu();
            
            // Обновляем избранное для всех предметов
            Object.keys(subjects).forEach(subject => updateFavorites(subject));
            
            // Проверяем стрик
            checkStreak();
            
            // Обновляем статистику главного меню
            updateMainMenuStats();
        }

        // События
        window.addEventListener('load', init);
        
        // Обработка ошибок
        window.onerror = function(msg, url, line) {
            console.error('Error: ', msg, ' at ', url, ':', line);
        };
    </script>
</body>
</html>
