<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegy S - –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ë–æ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        body{margin:0;padding:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);color:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh;overflow-y:auto;animation:fadeIn 1s ease-in-out;transition:background .5s;position:relative}
        body.dark{background:linear-gradient(135deg,#1e1e1e 0%,#333 100%);color:#ddd}
        .parallax-bg{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,rgba(0,0,0,0) 70%);pointer-events:none;animation:parallax 10s linear infinite}
        @keyframes parallax{0%{background-position:0 0}100%{background-position:100px 100px}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        h1{font-size:2.5em;margin:20px 0;text-shadow:0 2px 4px rgba(0,0,0,.3);animation:slideIn .5s ease-out}
        @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .section{background:rgba(255,255,255,.1);border-radius:15px;padding:20px;margin:20px;width:90%;max-width:600px;box-shadow:0 4px 15px rgba(0,0,0,.2);backdrop-filter:blur(10px);animation:cardAppear .8s ease-in-out}
        body.dark .section{background:rgba(0,0,0,.3)}
        @keyframes cardAppear{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
        .button{background:linear-gradient(135deg,#ff7e5f 0%,#feb47b 100%);border:none;border-radius:10px;color:#fff;padding:15px 30px;font-size:1.2em;margin:10px;cursor:pointer;transition:transform .3s,box-shadow .3s;box-shadow:0 4px 10px rgba(0,0,0,.2);animation:pulse 1.5s infinite}
        @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
        .button:hover{transform:scale(1.05);box-shadow:0 6px 15px rgba(0,0,0,.3)}
        .flashcard-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}
        .flashcard{background:#fff;color:#333;border-radius:10px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.1);text-align:center;transition:transform .5s;cursor:pointer}
        .flashcard.flipped{transform:rotateY(180deg)}
        body.dark .flashcard{background:#444;color:#fff}
        .flashcard img{max-width:100%;border-radius:10px;margin-bottom:10px;loading:lazy}
        .quiz-input{margin:10px 0;padding:10px;border-radius:5px;border:none;width:80%}
        .result{font-size:1.2em;margin-top:10px}
        .about-text{font-size:1em;line-height:1.5}
        .level-section{display:none}
        .confetti{position:absolute;width:10px;height:10px;background:#f00;animation:confetti-fall 1s linear}
        @keyframes confetti-fall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
        .progress-bar{background:#ddd;height:10px;border-radius:5px;margin:10px 0}
        .progress-fill{background:#4caf50;height:100%;border-radius:5px;transition:width .3s}
        .award{font-size:2em;animation:bounce 1s}
        @keyframes bounce{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
        .search-input{padding:10px;width:80%;margin-bottom:10px;border-radius:5px;border:none}
        iframe{width:100%;height:200px;border-radius:10px;margin:10px 0}
        .drag-container{display:flex;justify-content:space-around;margin:20px 0;gap:10px;flex-wrap:wrap}
        .drag-item{padding:10px;background:#eee;border-radius:5px;cursor:grab}
        body.dark .drag-item{background:#555}
        .drop-zone{padding:10px;border:2px dashed #ccc;min-height:50px;margin:10px;border-radius:8px}
        .streak{font-size:1em;color:gold;margin:10px}
    </style>
</head>
<body>
    <div class="parallax-bg"></div>
    <h1>Tegy S: –û–±—É—á–µ–Ω–∏–µ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h1>

    <div id="main-menu" class="section">
        <p id="menu-text">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è:</p>
        <select id="language-switch" onchange="app.switchLanguage(this.value)">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
        </select>
        <button class="button" onclick="app.showSection('english')"><i class="fas fa-book"></i> <span id="english-btn">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫</span></button>
        <button class="button" onclick="app.showSection('about')"><i class="fas fa-info-circle"></i> <span id="about-btn">–û –Ω–∞—Å</span></button>
        <button class="button" onclick="app.toggleTheme()"><i class="fas fa-moon"></i> <span id="theme-btn">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span></button>
        <p class="streak" id="streak-display">–°—Ç—Ä–∏–∫: 0 –¥–Ω–µ–π üî•</p>
    </div>

    <div id="english-section" class="section" style="display:none;">
        <h2 id="english-title">–£—Ä–æ–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</h2>
        <input type="text" class="search-input" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞–º..." oninput="app.searchFlashcards()">
        <p id="level-select-text">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:</p>
        <button class="button" onclick="app.showLevel('beginner')"><i class="fas fa-star"></i> <span id="beginner-btn">Beginner (–ù–∞—á–∏–Ω–∞—é—â–∏–π)</span></button>
        <button class="button" onclick="app.showLevel('intermediate')"><i class="fas fa-star-half-alt"></i> <span id="intermediate-btn">Intermediate (–°—Ä–µ–¥–Ω–∏–π)</span></button>
        <button class="button" onclick="app.showLevel('advanced')"><i class="fas fa-star"></i> <span id="advanced-btn">Advanced (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)</span></button>
        <button class="button" onclick="app.generateDailyChallenge()"><i class="fas fa-bolt"></i> <span id="challenge-btn">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—ã–∑–æ–≤</span></button>
        <button class="button" onclick="app.exportProgress()"><i class="fas fa-download"></i> <span id="export-btn">–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</span></button>

        <!-- Beginner -->
        <div id="beginner-level" class="level-section" style="display:none;">
            <h3 id="beginner-title">Beginner: –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-beginner" style="width:0%;"></div></div>
            <div class="flashcard-grid" id="flashcards-beginner"></div>
            <div id="quizzes-beginner"></div>
            <div class="drag-container" id="drag-beginner">
                <h4 id="drag-title-beginner">–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ (Drag-and-Drop)</h4>
                <div class="drag-items"></div>
                <div class="drop-zones"></div>
            </div>
            <button class="button" onclick="app.askAI('beginner')"><i class="fas fa-robot"></i> <span id="ai-beginner">–°–ø—Ä–æ—Å–∏ AI –æ–± –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏</span></button>
            <div id="award-beginner" style="display:none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="app.repeatLevel('beginner')"><span id="repeat-beginner">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</span></button>
            <button class="button" style="display:none;" id="next-beginner" onclick="app.showLevel('intermediate')"><span>–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: Intermediate</span></button>
            <button class="button" onclick="app.hideLevels()"><span id="back-btn-levels-1">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</span></button>
        </div>

        <!-- Intermediate -->
        <div id="intermediate-level" class="level-section" style="display:none;">
            <h3 id="intermediate-title">Intermediate: –§—Ä–∞–∑—ã –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-intermediate" style="width:0%;"></div></div>
            <div class="flashcard-grid" id="flashcards-intermediate"></div>
            <div id="quizzes-intermediate"></div>
            <div class="drag-container" id="drag-intermediate">
                <h4 id="drag-title-intermediate">–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Ñ—Ä–∞–∑—ã</h4>
                <div class="drag-items"></div>
                <div class="drop-zones"></div>
            </div>
            <button class="button" onclick="app.askAI('intermediate')"><i class="fas fa-robot"></i> <span id="ai-intermediate">–°–ø—Ä–æ—Å–∏ AI</span></button>
            <div id="award-intermediate" style="display:none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="app.repeatLevel('intermediate')"><span id="repeat-intermediate">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</span></button>
            <button class="button" style="display:none;" id="next-intermediate" onclick="app.showLevel('advanced')"><span>–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: Advanced</span></button>
            <button class="button" onclick="app.hideLevels()"><span id="back-btn-levels-2">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</span></button>
        </div>

        <!-- Advanced -->
        <div id="advanced-level" class="level-section" style="display:none;">
            <h3 id="advanced-title">Advanced: –ò–¥–∏–æ–º—ã –∏ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-advanced" style="width:0%;"></div></div>
            <div class="flashcard-grid" id="flashcards-advanced"></div>
            <div id="quizzes-advanced"></div>
            <div class="drag-container" id="drag-advanced">
                <h4 id="drag-title-advanced">–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –∏–¥–∏–æ–º—ã</h4>
                <div class="drag-items"></div>
                <div class="drop-zones"></div>
            </div>
            <button class="button" onclick="app.askAI('advanced')"><i class="fas fa-robot"></i> <span id="ai-advanced">–°–ø—Ä–æ—Å–∏ AI</span></button>
            <div id="award-advanced" style="display:none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="app.repeatLevel('advanced')"><span id="repeat-advanced">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</span></button>
            <button class="button" style="display:none;" id="next-advanced" onclick="app.showMainMenu()"><span>–ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é)</span></button>
            <button class="button" onclick="app.hideLevels()"><span id="back-btn-levels-3">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</span></button>
        </div>
    </div>

    <div id="about-section" class="section" style="display:none;">
        <h2 id="about-title">–û –Ω–∞—Å</h2>
        <p class="about-text" id="about-text">
            Tegcompany ‚Äî –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –≤ –†–µ—Å–ø—É–±–ª–∏–∫–µ –ë–µ–ª–∞—Ä—É—Å—å –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–º –Æ—Ä–∫–µ–≤–∏—á–µ–º –ê—Ä—Ç—ë–º–æ–º –ò–≥–æ—Ä–µ–≤–∏—á–µ–º. 
            –° –º–æ–º–µ–Ω—Ç–∞ —Å–≤–æ–µ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è Tegcompany —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–ª–∞—Å—å –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –Ω–∞—á–∞–≤ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤—ã—Ö —á–∞—Ç-–±–æ—Ç–æ–≤ 
            —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ ‚Äî Tegych P –∏ Beeprav P. –≠—Ç–∏ –ø—Ä–æ–µ–∫—Ç—ã —Å—Ç–∞–ª–∏ –æ—Ç–ø—Ä–∞–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏, 
            –∑–∞–ª–æ–∂–∏–≤ –æ—Å–Ω–æ–≤—É –¥–ª—è –±—É–¥—É—â–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤.
        </p>
        <button class="button" onclick="app.showMainMenu()"><span id="back-btn">–ù–∞–∑–∞–¥</span></button>
    </div>

    <script>
        // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Python-–±—ç–∫–µ–Ω–¥–æ–º =====
        // –û–∂–∏–¥–∞–µ–º—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (Flask/FastAPI):
        // POST /api/ai/explain  -> body: { level, prompt, tg_init } -> { answer }
        // POST /api/progress/save -> body: { progress, tg_init } -> { ok: true }
        const API_BASE = '/api';

        // –î–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–æ–≤ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        const lessons = {
            beginner: {
                flashcards: [
                    { word: 'Hello', translation: '–ü—Ä–∏–≤–µ—Ç', image: 'https://via.placeholder.com/150?text=Hello' },
                    { word: 'Thank you', translation: '–°–ø–∞—Å–∏–±–æ', image: 'https://via.placeholder.com/150?text=Thank+You' },
                    { word: 'Yes', translation: '–î–∞', image: 'https://via.placeholder.com/150?text=Yes' }
                ],
                quizzes: [
                    { question: '–ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å "–ü—Ä–∏–≤–µ—Ç" –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏?', answer: 'hello' },
                    { question: '–ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å "–°–ø–∞—Å–∏–±–æ" –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏?', answer: 'thank you' }
                ]
            },
            intermediate: {
                flashcards: [
                    { word: 'How are you?', translation: '–ö–∞–∫ –¥–µ–ª–∞?', image: 'https://via.placeholder.com/150?text=How+Are+You' },
                    { word: 'Good morning', translation: '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ', image: 'https://via.placeholder.com/150?text=Good+Morning' }
                ],
                quizzes: [
                    { question: '–ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å "–ö–∞–∫ –¥–µ–ª–∞?" –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏?', answer: 'how are you' },
                    { question: '–ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ" –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏?', answer: 'good morning' }
                ]
            },
            advanced: {
                flashcards: [
                    { word: 'Break a leg', translation: '–ù–∏ –ø—É—Ö–∞ –Ω–∏ –ø–µ—Ä–∞', image: 'https://via.placeholder.com/150?text=Break+A+Leg' },
                    { word: 'Piece of cake', translation: '–õ–µ–≥–∫–æ', image: 'https://via.placeholder.com/150?text=Piece+Of+Cake' }
                ],
                quizzes: [
                    { question: '–ß—Ç–æ –∑–Ω–∞—á–∏—Ç –∏–¥–∏–æ–º–∞ "Break a leg"?', answer: 'good luck' },
                    { question: '–ß—Ç–æ –∑–Ω–∞—á–∏—Ç "Piece of cake"?', answer: 'easy' }
                ]
            }
        };

        class TegyApp {
            constructor() {
                this.language = localStorage.getItem('tegyLang') || 'ru';
                this.progress = JSON.parse(localStorage.getItem('tegyProgress')) || { beginner: 0, intermediate: 0, advanced: 0 };
                this.streak = parseInt(localStorage.getItem('tegyStreak')) || 0;
                this.lastVisit = localStorage.getItem('tegyLastVisit') || new Date().toDateString();
                this.tg = window.Telegram?.WebApp;
                this.init();
            }

            init() {
                // Telegram WebApp init
                if (this.tg) {
                    this.tg.ready();
                    // MainButton (—Ñ–æ–ª–±—ç–∫ –Ω–∞ BackButton/sendData –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏)
                    try {
                        const btnText = this.getText('back-menu');
                        if (this.tg.MainButton) {
                            this.tg.MainButton.setText(btnText);
                            this.tg.MainButton.onClick(() => this.showMainMenu());
                            this.tg.MainButton.show();
                        } else if (this.tg.BackButton) {
                            this.tg.BackButton.onClick(() => this.showMainMenu());
                            this.tg.BackButton.show();
                        }
                    } catch (e) { console.warn('TG button init warn:', e); }
                }

                if (localStorage.getItem('tegyTheme') === 'dark') document.body.classList.add('dark');

                const today = new Date().toDateString();
                if (this.lastVisit !== today) {
                    this.streak = (this.lastVisit === new Date(Date.now() - 86400000).toDateString()) ? this.streak + 1 : 1;
                    localStorage.setItem('tegyStreak', this.streak);
                    localStorage.setItem('tegyLastVisit', today);
                }
                document.getElementById('streak-display').innerText = `${this.getText('streak')}: ${this.streak} –¥–Ω–µ–π üî•`;

                document.getElementById('language-switch').value = this.language;
                this.switchLanguage(this.language);

                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').catch(e => console.error('PWA error:', e));
                }

                this.showMainMenu();
            }

            get tgInitData() {
                // –ü–µ—Ä–µ–¥–∞—ë–º –≤ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram (hash check).
                // –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ initData (–∞ –Ω–µ unsafe).
                return this.tg?.initData || this.tg?.initDataUnsafe || '';
            }

            getText(key) {
                const texts = {
                    ru: {
                        'menu-text': '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è:',
                        'back-menu': '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é',
                        'english-btn': '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫',
                        'about-btn': '–û –Ω–∞—Å',
                        'theme-btn': '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞',
                        'streak': '–°—Ç—Ä–∏–∫',
                        'english-title': '–£—Ä–æ–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞',
                        'level-select-text': '–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å',
                        'beginner-btn': 'Beginner (–ù–∞—á–∏–Ω–∞—é—â–∏–π)',
                        'intermediate-btn': 'Intermediate (–°—Ä–µ–¥–Ω–∏–π)',
                        'advanced-btn': 'Advanced (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)',
                        'challenge-btn': '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—ã–∑–æ–≤',
                        'export-btn': '–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
                        'beginner-title': 'Beginner: –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã',
                        'intermediate-title': 'Intermediate: –§—Ä–∞–∑—ã –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞',
                        'advanced-title': 'Advanced: –ò–¥–∏–æ–º—ã –∏ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏',
                        'drag-title': '–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ (Drag-and-Drop)',
                        'ai-btn': '–°–ø—Ä–æ—Å–∏ AI –æ–± –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏',
                        'repeat-btn': '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å',
                        'next-btn': '–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å',
                        'finish-btn': '–ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é)',
                        'back-btn': '–ù–∞–∑–∞–¥',
                        'correct': '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ',
                        'incorrect': '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞!',
                        'checked': '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ',
                        'error': '–û—à–∏–±–∫–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
                        'ai-prompt': '–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è:',
                        'ai-error': '–û—à–∏–±–∫–∞ AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.',
                        'daily-challenge': '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—ã–∑–æ–≤',
                        'answer-placeholder': '–í–∞—à –æ—Ç–≤–µ—Ç',
                        'check': '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
                        'share': '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
                        'progress-share': '–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —É—Ä–æ–≤–Ω–µ'
                    },
                    en: {
                        'menu-text': 'Choose a learning path:',
                        'back-menu': 'Back to Menu',
                        'english-btn': 'English Language',
                        'about-btn': 'About Us',
                        'theme-btn': 'Dark Theme',
                        'streak': 'Streak',
                        'english-title': 'English Lessons',
                        'level-select-text': 'Choose Level',
                        'beginner-btn': 'Beginner',
                        'intermediate-btn': 'Intermediate',
                        'advanced-btn': 'Advanced',
                        'challenge-btn': 'Daily Challenge',
                        'export-btn': 'Export Progress',
                        'beginner-title': 'Beginner: Basic Words and Phrases',
                        'intermediate-title': 'Intermediate: Phrases and Grammar',
                        'advanced-title': 'Advanced: Idioms and Complex Structures',
                        'drag-title': 'Match Words (Drag-and-Drop)',
                        'ai-btn': 'Ask AI for Explanation',
                        'repeat-btn': 'Repeat Level',
                        'next-btn': 'Next Level',
                        'finish-btn': 'Finish English (Back to Menu)',
                        'back-btn': 'Back',
                        'correct': 'Correct! üéâ',
                        'incorrect': 'Incorrect. Try again!',
                        'checked': 'Checked',
                        'error': 'Error! Try again.',
                        'ai-prompt': 'Enter word or phrase for explanation:',
                        'ai-error': 'AI error. Check connection.',
                        'daily-challenge': 'Daily Challenge',
                        'answer-placeholder': 'Your answer',
                        'check': 'Check',
                        'share': 'Share',
                        'progress-share': 'My progress on level'
                    }
                };
                const pack = texts[this.language] || texts.ru;
                return pack[key] || key;
            }

            switchLanguage(lang) {
                this.language = lang;
                localStorage.setItem('tegyLang', lang);
                const ids = [
                    'menu-text','english-btn','about-btn','theme-btn','streak',
                    'english-title','level-select-text','beginner-btn','intermediate-btn','advanced-btn',
                    'challenge-btn','export-btn','beginner-title','intermediate-title','advanced-title',
                    'back-btn'
                ];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = this.getText(id);
                });
                // –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ —É—Ä–æ–≤–Ω–µ–π
                const map = [
                    ['ai-beginner','ai-btn'],['repeat-beginner','repeat-btn'],
                    ['ai-intermediate','ai-btn'],['repeat-intermediate','repeat-btn'],
                    ['ai-advanced','ai-btn'],['repeat-advanced','repeat-btn'],
                    ['drag-title-beginner','drag-title'],['drag-title-intermediate','drag-title'],['drag-title-advanced','drag-title'],
                    ['back-btn-levels-1','back-btn'],['back-btn-levels-2','back-btn'],['back-btn-levels-3','back-btn']
                ];
                map.forEach(([id,key])=>{
                    const el = document.getElementById(id);
                    if (el) el.innerText = this.getText(key);
                });
                // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å
                const openLevel = Array.from(document.querySelectorAll('.level-section')).find(x=>x.style.display==='block');
                if (openLevel) this.showLevel(openLevel.id.split('-')[0]);
                // –û–±–Ω–æ–≤–∏—Ç—å MainButton —Ç–µ–∫—Å—Ç
                if (this.tg?.MainButton) {
                    this.tg.MainButton.setText(this.getText('back-menu'));
                }
            }

            showSection(section) {
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById(`${section}-section`).style.display = 'block';
                if (this.tg?.MainButton) this.tg.MainButton.show();
            }

            showMainMenu() {
                document.querySelectorAll('.section:not(#main-menu)').forEach(sec => sec.style.display = 'none');
                document.getElementById('main-menu').style.display = 'block';
            }

            toggleTheme() {
                document.body.classList.toggle('dark');
                localStorage.setItem('tegyTheme', document.body.classList.contains('dark') ? 'dark' : 'light');
            }

            showLevel(level) {
                this.hideLevels();
                document.getElementById(`${level}-level`).style.display = 'block';
                this.generateFlashcards(level);
                this.generateQuizzes(level);
                this.setupDragAndDrop(level);
                this.updateProgress(level);
            }

            hideLevels() {
                document.querySelectorAll('.level-section').forEach(lvl => lvl.style.display = 'none');
            }

            generateFlashcards(level) {
                const grid = document.getElementById(`flashcards-${level}`);
                grid.innerHTML = '';
                lessons[level].flashcards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'flashcard';
                    div.innerHTML = `<img src="${card.image}" alt="${card.word}"><p>${card.word} - ${card.translation}</p>`;
                    div.onclick = () => div.classList.toggle('flipped');
                    grid.appendChild(div);
                });
            }

            generateQuizzes(level) {
                const quizzesDiv = document.getElementById(`quizzes-${level}`);
                quizzesDiv.innerHTML = '';
                lessons[level].quizzes.forEach((quiz, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = `<p>${quiz.question}</p>
                        <input type="text" id="quiz-${level}-${index}" class="quiz-input" placeholder="${this.getText('answer-placeholder')}">
                        <button class="button" onclick="app.checkQuiz('${level}-${index}', '${quiz.answer}', '${level}')">${this.getText('check')}</button>
                        <p id="result-${level}-${index}" class="result"></p>`;
                    quizzesDiv.appendChild(div);
                });
            }

            checkQuiz(quizId, correctAnswer, level) {
                try {
                    const input = document.getElementById(`quiz-${quizId}`);
                    const answer = (input.value || '').trim().toLowerCase();
                    const result = document.getElementById(`result-${quizId}`);
                    if (answer === correctAnswer.toLowerCase()) {
                        result.innerText = this.getText('correct');
                        result.style.color = 'lightgreen';
                        this.progress[level]++;
                        localStorage.setItem('tegyProgress', JSON.stringify(this.progress));
                        this.updateProgress(level);
                        this._confetti();
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –±–æ—Ç—É –∏ –±—ç–∫–µ–Ω–¥—É
                        this._sendTgEvent({ quiz: 'english', level, status: 'correct' });
                        this._saveProgress();
                    } else {
                        result.innerText = this.getText('incorrect');
                        result.style.color = 'salmon';
                        this._sendTgEvent({ quiz: 'english', level, status: 'incorrect' });
                    }
                    input.disabled = true;
                    const button = input.nextElementSibling;
                    button.disabled = true;
                    button.innerText = this.getText('checked');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≤ –∫–≤–∏–∑–µ:', e);
                    const res = document.getElementById(`result-${quizId}`);
                    if (res) res.innerText = this.getText('error');
                }
            }

            updateProgress(level) {
                const prog = this.progress[level] || 0;
                const max = lessons[level].quizzes.length + lessons[level].flashcards.length;
                const width = Math.min((prog / max) * 100, 100);
                document.getElementById(`progress-${level}`).style.width = `${width}%`;
                if (width >= 100) {
                    document.getElementById(`award-${level}`).style.display = 'block';
                    document.getElementById(`next-${level}`).style.display = 'block';
                    this._sendTgEvent({ award: true, level });
                    this._saveProgress();
                }
            }

            repeatLevel(level) {
                this.progress[level] = 0;
                localStorage.setItem('tegyProgress', JSON.stringify(this.progress));
                this.showLevel(level);
                this._saveProgress();
            }

            searchFlashcards() {
                const query = document.getElementById('search').value.toLowerCase();
                document.querySelectorAll('.flashcard').forEach(card => {
                    card.style.display = card.textContent.toLowerCase().includes(query) ? 'block' : 'none';
                });
            }

            async askAI(level) {
                const prompt = window.prompt(this.getText('ai-prompt'));
                if (!prompt) return;
                try {
                    const resp = await fetch(`${API_BASE}/ai/explain`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ level, prompt, tg_init: this.tgInitData })
                    });
                    if (!resp.ok) throw new Error('Bad response');
                    const data = await resp.json();
                    alert(data.answer || '[no answer]');
                } catch (e) {
                    console.error('AI error:', e);
                    alert(this.getText('ai-error'));
                }
            }

            generateDailyChallenge() {
                const levels = ['beginner', 'intermediate', 'advanced'];
                const randomLevel = levels[Math.floor(Math.random() * levels.length)];
                const randomQuiz = lessons[randomLevel].quizzes[Math.floor(Math.random() * lessons[randomLevel].quizzes.length)];
                if (document.getElementById('daily-challenge-div')) return;
                const challengeDiv = document.createElement('div');
                challengeDiv.id = 'daily-challenge-div';
                challengeDiv.innerHTML = `<p>${this.getText('daily-challenge')}: ${randomQuiz.question} (Level: ${randomLevel})</p>
                    <input type="text" id="challenge-input" class="quiz-input" placeholder="${this.getText('answer-placeholder')}">
                    <button class="button" onclick="app.checkQuiz('challenge', '${randomQuiz.answer}', '${randomLevel}')">${this.getText('check')}</button>
                    <p id="result-challenge" class="result"></p>`;
                document.getElementById('english-section').appendChild(challengeDiv);
            }

            exportProgress() {
                const data = JSON.stringify(this.progress);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tegy_progress.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            setupDragAndDrop(level) {
                const container = document.getElementById(`drag-${level}`);
                container.innerHTML = `<h4>${this.getText('drag-title')}</h4><div class="drag-items"></div><div class="drop-zones"></div>`;
                const words = lessons[level].flashcards.slice(0, 3).map(f => f.word);
                const translations = lessons[level].flashcards.slice(0, 3).map(f => f.translation).sort(() => Math.random() - 0.5);

                words.forEach(w => {
                    const item = document.createElement('div');
                    item.className = 'drag-item';
                    item.draggable = true;
                    item.innerText = w;
                    item.ondragstart = e => e.dataTransfer.setData('text/plain', w);
                    container.querySelector('.drag-items').appendChild(item);
                });

                translations.forEach(t => {
                    const zone = document.createElement('div');
                    zone.className = 'drop-zone';
                    zone.innerText = t;
                    zone.ondrop = e => {
                        e.preventDefault();
                        const data = e.dataTransfer.getData('text/plain');
                        const correct = lessons[level].flashcards.find(f => f.word === data && f.translation === t);
                        zone.style.background = correct ? 'rgba(76,175,80,.4)' : 'rgba(244,67,54,.4)';
                        if (correct) {
                            this.progress[level]++;
                            localStorage.setItem('tegyProgress', JSON.stringify(this.progress));
                            this.updateProgress(level);
                            this._sendTgEvent({ type: 'drag', status: 'correct', level });
                            this._saveProgress();
                        } else {
                            this._sendTgEvent({ type: 'drag', status: 'incorrect', level });
                        }
                    };
                    zone.ondragover = e => e.preventDefault();
                    container.querySelector('.drop-zones').appendChild(zone);
                });
            }

            _confetti() {
                for (let i = 0; i < 20; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.top = `${Math.random() * 100}vh`;
                    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confetti.style.animationDuration = `${Math.random() * 2 + 1}s`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }
            }

            _sendTgEvent(payload) {
                try {
                    if (this.tg?.sendData) {
                        this.tg.sendData(JSON.stringify(payload));
                    }
                } catch(e){ console.warn('sendData warn:', e); }
            }

            async _saveProgress() {
                try {
                    await fetch(`${API_BASE}/progress/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ progress: this.progress, tg_init: this.tgInitData })
                    });
                } catch(e) {
                    console.warn('Progress save failed (non-critical):', e);
                }
            }
        }

        const app = new TegyApp();
    </script>
</body>
</html>
