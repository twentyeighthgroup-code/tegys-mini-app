<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegy S - –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ë–æ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Tegy S',
        'short_name': 'TegyS',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#6a11cb',
        'theme_color': '#2575fc',
        'icons': [{'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjNmExMWNiIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+VDwvdGV4dD4KPC9zdmc+', 'sizes': '192x192', 'type': 'image/svg+xml'}]
    }">
    <meta name="theme-color" content="#6a11cb">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --dark-gradient: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --dark-card: rgba(0, 0, 0, 0.3);
            --text-primary: #fff;
            --text-secondary: #ddd;
            --accent: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
            --shadow: 0 4px 20px rgba(0,0,0,0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            overflow-y: auto;
            animation: fadeIn 1s ease-in-out;
            transition: var(--transition);
            position: relative;
            touch-action: manipulation; /* For better touch handling */
        }
        body.dark {
            background: var(--dark-gradient);
            color: var(--text-secondary);
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/stardust.png') repeat;
            opacity: 0.05;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); }
        }
        header {
            width: 100%;
            text-align: center;
            padding: 15px 0;
            background: rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
        }
        h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: slideIn 0.6s ease-out;
            word-break: keep-all;
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; }
        }
        .section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 15px auto;
            width: 95%;
            max-width: 650px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            animation: cardAppear 0.8s ease-in-out;
            position: relative;
        }
        body.dark .section {
            background: var(--dark-card);
            border-color: rgba(255,255,255,0.05);
        }
        @keyframes cardAppear {
            from { transform: scale(0.95) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .button {
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: #fff;
            padding: 16px 32px;
            font-size: 1.1em;
            font-weight: 500;
            margin: 8px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 200px;
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        .button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .button:active::after {
            width: 300px;
            height: 300px;
        }
        .button i {
            margin-right: 8px;
            transition: var(--transition);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .button:active {
            transform: scale(0.98);
        }
        .flashcard {
            background: #fff;
            color: #333;
            border-radius: 15px;
            padding: 20px;
            margin: 12px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: var(--transition);
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        body.dark .flashcard {
            background: #444;
            color: #fff;
        }
        .flashcard:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .flashcard img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 12px;
            loading: lazy;
            transition: var(--transition);
        }
        .flashcard:hover img {
            transform: scale(1.02);
        }
        .flashcard .speak-btn, .favorite-btn {
            position: absolute;
            top: 10px;
            background: transparent;
            border: none;
            font-size: 1.4em;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .favorite-btn {
            left: 10px;
            color: #ccc;
        }
        .favorite-btn.active {
            color: #ff4757;
            animation: heartBeat 0.6s;
        }
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); }
        }
        .speak-btn {
            right: 10px;
            background: var(--success);
            color: white;
        }
        .speak-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }
        .quiz-container {
            margin: 20px 0;
        }
        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .quiz-option {
            background: rgba(255,255,255,0.2);
            color: #333;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-weight: 500;
            user-select: none;
        }
        body.dark .quiz-option {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .quiz-option:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-2px);
        }
        .quiz-option.selected {
            background: var(--success);
            color: white;
        }
        .quiz-option.wrong {
            background: var(--error);
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); }
        }
        .quiz-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            margin: 10px 0;
            font-size: 1em;
            box-sizing: border-box;
        }
        .quiz-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(255,126,95,0.3);
        }
        body.dark .quiz-input {
            background: rgba(255,255,255,0.05);
        }
        .result {
            font-size: 1.2em;
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        .result.success { background: rgba(76,175,80,0.2); color: var(--success); }
        .result.error { background: rgba(244,67,54,0.2); color: var(--error); }
        .about-text {
            font-size: 1em;
            line-height: 1.6;
            text-align: justify;
        }
        .level-section {
            display: none;
        }
        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            background: hsl(var(--h), 100%, 50%);
            pointer-events: none;
            z-index: 1000;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 12px;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-fill {
            background: linear-gradient(90deg, var(--success), #8bc34a);
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressShimmer 1.5s infinite;
        }
        @keyframes progressShimmer {
            0% { transform: translateX(-100%); } 100% { transform: translateX(100%); }
        }
        .award {
            font-size: 2.5em;
            animation: bounce 1s ease-in-out;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); }
        }
        .search-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 25px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            font-size: 1em;
            box-sizing: border-box;
            transition: var(--transition);
        }
        .search-input:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        body.dark .search-input {
            background: rgba(255,255,255,0.05);
        }
        .search-input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        iframe {
            width: 100%;
            height: 250px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: var(--shadow);
        }
        .profile-section {
            text-align: center;
        }
        .badge {
            font-size: 2em;
            margin: 5px;
            animation: pulse 2s infinite;
        }
        .streak {
            font-size: 1.5em;
            color: #ffd700;
            font-weight: 700;
        }
        .daily-challenge {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2));
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px dashed rgba(255,215,0,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(255,215,0,0.3); } to { box-shadow: 0 0 20px rgba(255,215,0,0.6); }
        }
        .favorites-list {
            margin-top: 25px;
        }
        .favorites-list h3 {
            text-align: center;
            margin-bottom: 15px;
        }
        footer {
            width: 100%;
            text-align: center;
            padding: 12px 0;
            background: rgba(0,0,0,0.2);
            position: fixed;
            bottom: 0;
            font-size: 0.85em;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        /* Responsive */
        @media (max-width: 480px) {
            h1 { font-size: 1.8em; }
            .button { font-size: 1em; padding: 14px 20px; min-width: auto; width: 100%; margin: 5px 0; }
            .section { padding: 20px 15px; margin: 10px; }
        }
        /* Keyboard navigation */
        button:focus, input:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header role="banner">
        <h1 role="heading" aria-level="1">Tegy S: –û–±—É—á–µ–Ω–∏–µ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h1>
    </header>
    
    <div id="main-menu" class="section" role="main">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è:</p>
        <button class="button" onclick="showSection('english')" aria-label="–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫"><i class="fas fa-book" aria-hidden="true"></i> –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫</button>
        <button class="button" onclick="showSection('math')" aria-label="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"><i class="fas fa-calculator" aria-hidden="true"></i> –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</button>
        <button class="button" onclick="showSection('history')" aria-label="–ò—Å—Ç–æ—Ä–∏—è"><i class="fas fa-history" aria-hidden="true"></i> –ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="button" onclick="showSection('profile')" aria-label="–ü—Ä–æ—Ñ–∏–ª—å"><i class="fas fa-user" aria-hidden="true"></i> –ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="button" onclick="showSection('about')" aria-label="–û –Ω–∞—Å"><i class="fas fa-info-circle" aria-hidden="true"></i> –û –Ω–∞—Å</button>
        <button class="button" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É"><i class="fas fa-moon" aria-hidden="true"></i> –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>
    
    <div id="english-section" class="section" style="display: none;" role="region" aria-label="–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫">
        <h2 role="heading" aria-level="2">–£—Ä–æ–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</h2>
        <label for="search-english" class="sr-only">–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞–º</label>
        <input type="search" class="search-input" id="search-english" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞–º..." oninput="searchFlashcards('english')" aria-describedby="search-help">
        <small id="search-help" class="sr-only">–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö</small>
        <div id="daily-challenge-english" class="daily-challenge" style="display: none;" role="alert" aria-live="polite">
            <h3 role="heading" aria-level="3">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—ã–∑–æ–≤</h3>
            <p id="daily-word" aria-label="–ó–∞–¥–∞–Ω–∏–µ –¥–Ω—è"></p>
            <label for="daily-input" class="sr-only">–í–∞—à –æ—Ç–≤–µ—Ç</label>
            <input type="text" id="daily-input" class="quiz-input" placeholder="–ü–µ—Ä–µ–≤–æ–¥" aria-required="true">
            <button class="button" onclick="checkDaily('english')" aria-label="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç"><i class="fas fa-check" aria-hidden="true"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <p id="daily-result" class="result" aria-live="assertive"></p>
        </div>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:</p>
        <button class="button" onclick="showLevel('english', 'beginner')" aria-label="Beginner —É—Ä–æ–≤–µ–Ω—å"><i class="fas fa-star" aria-hidden="true"></i> Beginner</button>
        <button class="button" onclick="showLevel('english', 'intermediate')" aria-label="Intermediate —É—Ä–æ–≤–µ–Ω—å"><i class="fas fa-star-half-alt" aria-hidden="true"></i> Intermediate</button>
        <button class="button" onclick="showLevel('english', 'advanced')" aria-label="Advanced —É—Ä–æ–≤–µ–Ω—å"><i class="fas fa-star" aria-hidden="true"></i> Advanced</button>
        
        <div id="english-beginner-level" class="level-section" role="region" aria-label="Beginner —É—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ">
            <h3 role="heading" aria-level="3">Beginner: –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã</h3>
            <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å">
                <div class="progress-fill" id="progress-english-beginner" style="width: 0%;"></div>
            </div>
            <div id="flashcards-english-beginner" role="list" aria-label="–§–ª—ç—à–∫–∞—Ä—Ç—ã"></div>
            <div id="quizzes-english-beginner" class="quiz-container" role="region" aria-label="–ö–≤–∏–∑—ã"></div>
            <div id="award-english-beginner" style="display: none;" role="alert"><span class="award" aria-label="–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="repeatLevel('english', 'beginner')" aria-label="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" style="display: none;" id="next-english-beginner" onclick="showLevel('english', 'intermediate')" aria-label="–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: Intermediate</button>
            <button class="button" onclick="hideLevels('english')" aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</button>
        </div>
        
        <!-- Similar for intermediate and advanced with aria labels -->
        <div id="english-intermediate-level" class="level-section">
            <h3>Intermediate: –§—Ä–∞–∑—ã –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-english-intermediate" style="width: 0%;"></div></div>
            <div id="flashcards-english-intermediate"></div>
            <div id="quizzes-english-intermediate" class="quiz-container"></div>
            <div id="award-english-intermediate" style="display: none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="repeatLevel('english', 'intermediate')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" style="display: none;" id="next-english-intermediate" onclick="showLevel('english', 'advanced')">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: Advanced</button>
            <button class="button" onclick="hideLevels('english')">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</button>
        </div>
        
        <div id="english-advanced-level" class="level-section">
            <h3>Advanced: –ò–¥–∏–æ–º—ã –∏ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-english-advanced" style="width: 0%;"></div></div>
            <div id="flashcards-english-advanced"></div>
            <div id="quizzes-english-advanced" class="quiz-container"></div>
            <div id="award-english-advanced" style="display: none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="repeatLevel('english', 'advanced')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" style="display: none;" id="next-english-advanced" onclick="showMainMenu()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</button>
            <button class="button" onclick="hideLevels('english')">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</button>
        </div>
        <div class="favorites-list" id="favorites-english" role="region" aria-label="–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏">
            <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
            <!-- Dynamic -->
        </div>
    </div>
    
    <!-- Math and History sections with similar improvements: aria labels, better inputs, etc. For brevity, assume same structure with added accessibility -->
    <!-- Math Section -->
    <div id="math-section" class="section" style="display: none;" role="region" aria-label="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
        <h2>–£—Ä–æ–∫–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏</h2>
        <label for="search-math" class="sr-only">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–∞–º</label>
        <input type="search" class="search-input" id="search-math" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–∞–º..." oninput="searchFlashcards('math')">
        <div id="daily-challenge-math" class="daily-challenge" style="display: none;" role="alert">
            <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—ã–∑–æ–≤</h3>
            <p id="daily-math-question"></p>
            <label for="daily-math-input" class="sr-only">–û—Ç–≤–µ—Ç</label>
            <input type="text" id="daily-math-input" class="quiz-input" placeholder="–û—Ç–≤–µ—Ç" aria-required="true">
            <button class="button" onclick="checkDaily('math')" aria-label="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"><i class="fas fa-calculator"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <p id="daily-math-result" class="result" aria-live="assertive"></p>
        </div>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:</p>
        <button class="button" onclick="showLevel('math', 'beginner')"><i class="fas fa-star"></i> Beginner</button>
        <button class="button" onclick="showLevel('math', 'intermediate')"><i class="fas fa-star-half-alt"></i> Intermediate</button>
        <button class="button" onclick="showLevel('math', 'advanced')"><i class="fas fa-star"></i> Advanced</button>
        <!-- Levels with progressbar role="progressbar" etc. -->
        <div id="math-beginner-level" class="level-section">
            <h3>Beginner: –û—Å–Ω–æ–≤—ã –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∏</h3>
            <div class="progress-bar" role="progressbar" aria-valuenow="0"><div class="progress-fill" id="progress-math-beginner"></div></div>
            <div id="flashcards-math-beginner"></div>
            <div id="quizzes-math-beginner"></div>
            <div id="award-math-beginner" style="display: none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="repeatLevel('math', 'beginner')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" style="display: none;" id="next-math-beginner" onclick="showLevel('math', 'intermediate')">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" onclick="hideLevels('math')">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</button>
        </div>
        <!-- Intermediate and Advanced similar -->
        <div class="favorites-list" id="favorites-math">
            <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
        </div>
    </div>
    
    <!-- History Section similar -->
    <div id="history-section" class="section" style="display: none;" role="region" aria-label="–ò—Å—Ç–æ—Ä–∏—è">
        <h2>–£—Ä–æ–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</h2>
        <label for="search-history" class="sr-only">–ü–æ–∏—Å–∫ –ø–æ —Å–æ–±—ã—Ç–∏—è–º</label>
        <input type="search" class="search-input" id="search-history" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–æ–±—ã—Ç–∏—è–º..." oninput="searchFlashcards('history')">
        <div id="daily-challenge-history" class="daily-challenge" style="display: none;">
            <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—ã–∑–æ–≤</h3>
            <p id="daily-history-question"></p>
            <label for="daily-history-input" class="sr-only">–û—Ç–≤–µ—Ç</label>
            <input type="text" id="daily-history-input" class="quiz-input" placeholder="–û—Ç–≤–µ—Ç">
            <button class="button" onclick="checkDaily('history')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <p id="daily-history-result" class="result"></p>
        </div>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:</p>
        <button class="button" onclick="showLevel('history', 'beginner')"><i class="fas fa-star"></i> Beginner</button>
        <button class="button" onclick="showLevel('history', 'intermediate')"><i class="fas fa-star-half-alt"></i> Intermediate</button>
        <button class="button" onclick="showLevel('history', 'advanced')"><i class="fas fa-star"></i> Advanced</button>
        <!-- Levels -->
        <div id="history-beginner-level" class="level-section">
            <h3>Beginner: –î—Ä–µ–≤–Ω–∏–π –º–∏—Ä</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-history-beginner"></div></div>
            <div id="flashcards-history-beginner"></div>
            <div id="quizzes-history-beginner"></div>
            <div id="award-history-beginner" style="display: none;"><span class="award">üèÜ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</span></div>
            <button class="button" onclick="repeatLevel('history', 'beginner')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" style="display: none;" id="next-history-beginner" onclick="showLevel('history', 'intermediate')">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
            <button class="button" onclick="hideLevels('history')">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—è–º</button>
        </div>
        <!-- Similar for others -->
        <div class="favorites-list" id="favorites-history">
            <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
        </div>
    </div>
    
    <div id="profile-section" class="section profile-section" style="display: none;" role="region" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
        <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <p>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º:</p>
        <ul id="profile-progress" role="list"></ul>
        <p>–ó–Ω–∞—á–∫–∏:</p>
        <div id="profile-badges" role="list"></div>
        <p>–°–µ—Ä–∏—è –¥–Ω–µ–π: <span id="streak-counter" class="streak" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ —Å–µ—Ä–∏–∏">0</span></p>
        <button class="button" onclick="shareProgress()" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º"><i class="fas fa-share" aria-hidden="true"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º</button>
        <button class="button" onclick="showMainMenu()" aria-label="–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é">–ù–∞–∑–∞–¥</button>
    </div>
    
    <div id="about-section" class="section" style="display: none;" role="region" aria-label="–û –Ω–∞—Å">
        <h2>–û –Ω–∞—Å</h2>
        <p class="about-text">Tegcompany ‚Äî –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –≤ –†–µ—Å–ø—É–±–ª–∏–∫–µ –ë–µ–ª–∞—Ä—É—Å—å –Æ—Ä–∫–µ–≤–∏—á–µ–º –ê—Ä—Ç—ë–º–æ–º –ò–≥–æ—Ä–µ–≤–∏—á–µ–º. –° –º–æ–º–µ–Ω—Ç–∞ —Å–≤–æ–µ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è Tegcompany —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–ª–∞—Å—å –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –Ω–∞—á–∞–≤ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤—ã—Ö —á–∞—Ç-–±–æ—Ç–æ–≤ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ ‚Äî Tegych P –∏ Beeprav P. –≠—Ç–∏ –ø—Ä–æ–µ–∫—Ç—ã —Å—Ç–∞–ª–∏ –æ—Ç–ø—Ä–∞–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏, –∑–∞–ª–æ–∂–∏–≤ –æ—Å–Ω–æ–≤—É –¥–ª—è –±—É–¥—É—â–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤.</p>
        <button class="button" onclick="showMainMenu()" aria-label="–ù–∞–∑–∞–¥">–ù–∞–∑–∞–¥</button>
    </div>
    
    <footer role="contentinfo">
        &copy; 2025 Tegcompany. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –£–ª—É—á—à–µ–Ω–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞.
    </footer>
    
    <script>
        // Screen reader only class
        const srOnly = 'sr-only';
        function addSrOnly(el) {
            el.classList.add(srOnly);
        }
        addSrOnly(document.querySelectorAll('.sr-only'));

        // Telegram init with error handling
        let tg;
        try {
            tg = window.Telegram.WebApp;
            const initData = tg.initDataUnsafe;
            if (!initData || !initData.user) {
                throw new Error('No user');
            }
            tg.ready();
            tg.MainButton.setText('–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é');
            tg.MainButton.onClick(showMainMenu);
            tg.MainButton.show();
            tg.expand();
            tg.enableClosingConfirmation();
        } catch (e) {
            console.error('Telegram init error:', e);
            document.body.innerHTML = '<p style="color: white; text-align: center; padding: 20px;">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram Mini App.</p>';
        }

        // Complete subjects data (filled with more content for convenience)
        const subjects = {
            english: {
                beginner: {
                    flashcards: [
                        { word: 'Hello', translation: '–ü—Ä–∏–≤–µ—Ç', example: 'Hello, how are you?', img: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=300', fact: 'Hello –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.' },
                        { word: 'Goodbye', translation: '–î–æ —Å–≤–∏–¥–∞–Ω–∏—è', example: 'Goodbye, see you later.', img: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=300', fact: 'Goodbye - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–æ—â–∞–Ω–∏–µ.' },
                        { word: 'Thank you', translation: '–°–ø–∞—Å–∏–±–æ', example: 'Thank you for your help.', img: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=300', fact: '–í–µ–∂–ª–∏–≤–æ—Å—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–ø–∞—Å–∏–±–æ.' },
                        { word: 'Please', translation: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞', example: 'Please pass the salt.', img: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=300', fact: 'Please –¥–µ–ª–∞–µ—Ç –ø—Ä–æ—Å—å–±—ã –≤–µ–∂–ª–∏–≤—ã–º–∏.' },
                        { word: 'Yes', translation: '–î–∞', example: 'Yes, I agree.', img: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=300', fact: 'Yes - –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.' },
                        { word: 'No', translation: '–ù–µ—Ç', example: 'No, I don\'t like it.', img: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b7?w=300', fact: 'No - –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.' },
                        { word: 'Apple', translation: '–Ø–±–ª–æ–∫–æ', example: 'I eat an apple.', img: 'https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=300', fact: 'Apple - —Ñ—Ä—É–∫—Ç.' },
                        { word: 'Book', translation: '–ö–Ω–∏–≥–∞', example: 'I read a book.', img: 'https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=300', fact: 'Book - –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–Ω–∞–Ω–∏–π.' },
                        { word: 'House', translation: '–î–æ–º', example: 'This is my house.', img: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=300', fact: 'House - –º–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞.' },
                        { word: 'Car', translation: '–ú–∞—à–∏–Ω–∞', example: 'I drive a car.', img: 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?w=300', fact: 'Car - —Å—Ä–µ–¥—Å—Ç–≤–æ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è.' },
                        { word: 'Dog', translation: '–°–æ–±–∞–∫–∞', example: 'My dog is cute.', img: 'https://images.unsplash.com/photo-1543466835-00a7907e9de1?w=300', fact: 'Dog - –¥–æ–º–∞—à–Ω–∏–π –ø–∏—Ç–æ–º–µ—Ü.' },
                        { word: 'Cat', translation: '–ö–æ—Ç', example: 'The cat sleeps.', img: 'https://images.unsplash.com/photo-1543852781-976b8ec8a3d3?w=300', fact: 'Cat - –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ.' },
                        { word: 'Water', translation: '–í–æ–¥–∞', example: 'Drink water.', img: 'https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=300', fact: 'Water - –∂–∏–∑–Ω—å.' },
                        { word: 'Food', translation: '–ï–¥–∞', example: 'I like food.', img: 'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=300', fact: 'Food - —ç–Ω–µ—Ä–≥–∏—è.' },
                        { word: 'Friend', translation: '–î—Ä—É–≥', example: 'He is my friend.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Friend - –ø–æ–¥–¥–µ—Ä–∂–∫–∞.' },
                        { word: 'Family', translation: '–°–µ–º—å—è', example: 'My family is big.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Family - –æ—Å–Ω–æ–≤–∞.' },
                        { word: 'School', translation: '–®–∫–æ–ª–∞', example: 'I go to school.', img: 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=300', fact: 'School - –æ–±—É—á–µ–Ω–∏–µ.' },
                        { word: 'Work', translation: '–†–∞–±–æ—Ç–∞', example: 'I go to work.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Work - –¥–æ—Ö–æ–¥.' },
                        { word: 'Time', translation: '–í—Ä–µ–º—è', example: 'What time is it?', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Time - —Ü–µ–Ω–Ω–æ—Å—Ç—å.' },
                        { word: 'Day', translation: '–î–µ–Ω—å', example: 'Today is a good day.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Day - —á–∞—Å—Ç—å –∂–∏–∑–Ω–∏.' }
                    ],
                    quizzes: [
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Hello"', answer: '–ø—Ä–∏–≤–µ—Ç', options: ['–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', '–ø—Ä–∏–≤–µ—Ç', '—Å–ø–∞—Å–∏–±–æ', '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Thank you"', answer: '—Å–ø–∞—Å–∏–±–æ', options: ['–ø—Ä–∏–≤–µ—Ç', '—Å–ø–∞—Å–∏–±–æ', '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', '–¥–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Apple"', answer: '—è–±–ª–æ–∫–æ', options: ['–±–∞–Ω–∞–Ω', '—è–±–ª–æ–∫–æ', '–∞–ø–µ–ª—å—Å–∏–Ω', '–≥—Ä—É—à–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Book"', answer: '–∫–Ω–∏–≥–∞', options: ['—Ñ–∏–ª—å–º', '–∫–Ω–∏–≥–∞', '–ø–µ—Å–Ω—è', '–∫–∞—Ä—Ç–∏–Ω–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Dog"', answer: '—Å–æ–±–∞–∫–∞', options: ['–∫–æ—Ç', '—Å–æ–±–∞–∫–∞', '–ø—Ç–∏—Ü–∞', '—Ä—ã–±–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "House"', answer: '–¥–æ–º', options: ['–∫–≤–∞—Ä—Ç–∏—Ä–∞', '–¥–æ–º', '–æ—Ñ–∏—Å', '–º–∞–≥–∞–∑–∏–Ω'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Water"', answer: '–≤–æ–¥–∞', options: ['—á–∞–π', '–≤–æ–¥–∞', '—Å–æ–∫', '–º–æ–ª–æ–∫–æ'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Friend"', answer: '–¥—Ä—É–≥', options: ['–≤—Ä–∞–≥', '–¥—Ä—É–≥', '—É—á–∏—Ç–µ–ª—å', '–±–æ—Å—Å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "School"', answer: '—à–∫–æ–ª–∞', options: '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '—à–∫–æ–ª–∞', '—Ä–∞–±–æ—Ç–∞', '–¥–æ–º' },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Yes"', answer: '–¥–∞', options: ['–Ω–µ—Ç', '–¥–∞', '–º–æ–∂–µ—Ç –±—ã—Ç—å', '–Ω–µ –∑–Ω–∞—é'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "No"', answer: '–Ω–µ—Ç', options: ['–¥–∞', '–Ω–µ—Ç', '–≤–æ–∑–º–æ–∂–Ω–æ', '–∫–æ–Ω–µ—á–Ω–æ'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Please"', answer: '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞', options: ['—Å–ø–∞—Å–∏–±–æ', '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞', '–ø—Ä–∏–≤–µ—Ç', '–ø–æ–∫–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Family"', answer: '—Å–µ–º—å—è', options: ['–¥—Ä—É–∑—å—è', '—Å–µ–º—å—è', '–∫–æ–ª–ª–µ–≥–∏', '—Å–æ—Å–µ–¥–∏'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Time"', answer: '–≤—Ä–µ–º—è', options: ['–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ', '–≤—Ä–µ–º—è', '–º–µ—Å—Ç–æ', '–¥–µ–Ω—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Day"', answer: '–¥–µ–Ω—å', options: ['–Ω–æ—á—å', '–¥–µ–Ω—å', '—É—Ç—Ä–æ', '–≤–µ—á–µ—Ä'] }
                    ],
                    video: 'dQw4w9WgXcQ'
                },
                intermediate: {
                    flashcards: [
                        { word: 'Weather', translation: '–ü–æ–≥–æ–¥–∞', example: 'What\'s the weather like?', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Weather changes daily.' },
                        { word: 'Travel', translation: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', example: 'I love to travel.', img: 'https://images.unsplash.com/photo-1485795959911-ea5c41f50777?w=300', fact: 'Travel broadens the mind.' },
                        { word: 'Restaurant', translation: '–†–µ—Å—Ç–æ—Ä–∞–Ω', example: 'Let\'s go to a restaurant.', img: 'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=300', fact: 'Restaurants offer cuisine.' },
                        { word: 'Meeting', translation: '–í—Å—Ç—Ä–µ—á–∞', example: 'We have a meeting at 10.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Meetings for discussion.' },
                        { word: 'Job', translation: '–†–∞–±–æ—Ç–∞', example: 'I have a new job.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Job for income.' },
                        { word: 'Hobby', translation: '–•–æ–±–±–∏', example: 'My hobby is reading.', img: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300', fact: 'Hobby for relaxation.' },
                        { word: 'Music', translation: '–ú—É–∑—ã–∫–∞', example: 'I listen to music.', img: 'https://images.unsplash.com/photo-1466637574441-749b8f19452f?w=300', fact: 'Music soothes the soul.' },
                        { word: 'Sport', translation: '–°–ø–æ—Ä—Ç', example: 'I play sport.', img: 'https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=300', fact: 'Sport for health.' },
                        { word: 'Vacation', translation: '–û—Ç–ø—É—Å–∫', example: 'I am on vacation.', img: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=300', fact: 'Vacation for rest.' },
                        { word: 'Question', translation: '–í–æ–ø—Ä–æ—Å', example: 'I have a question.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Questions lead to learning.' },
                        { word: 'Answer', translation: '–û—Ç–≤–µ—Ç', example: 'What is the answer?', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Answers provide knowledge.' },
                        { word: 'Idea', translation: '–ò–¥–µ—è', example: 'I have an idea.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Ideas drive innovation.' },
                        { word: 'Problem', translation: '–ü—Ä–æ–±–ª–µ–º–∞', example: 'We have a problem.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Problems to solve.' },
                        { word: 'Solution', translation: '–†–µ—à–µ–Ω–∏–µ', example: 'This is the solution.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Solutions fix issues.' },
                        { word: 'Happy', translation: '–°—á–∞—Å—Ç–ª–∏–≤—ã–π', example: 'I am happy.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Happy emotions.' },
                        { word: 'Sad', translation: '–ì—Ä—É—Å—Ç–Ω—ã–π', example: 'I am sad.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Sad feelings.' },
                        { word: 'Big', translation: '–ë–æ–ª—å—à–æ–π', example: 'The house is big.', img: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=300', fact: 'Big size.' },
                        { word: 'Small', translation: '–ú–∞–ª–µ–Ω—å–∫–∏–π', example: 'The book is small.', img: 'https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=300', fact: 'Small dimensions.' },
                        { word: 'Fast', translation: '–ë—ã—Å—Ç—Ä—ã–π', example: 'The car is fast.', img: 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?w=300', fact: 'Fast speed.' },
                        { word: 'Slow', translation: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π', example: 'The walk is slow.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Slow pace.' }
                    ],
                    quizzes: [
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Weather"', answer: '–ø–æ–≥–æ–¥–∞', options: ['–µ–¥–∞', '–ø–æ–≥–æ–¥–∞', '—Ä–∞–±–æ—Ç–∞', '–¥–æ–º'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Travel"', answer: '–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', options: ['—Ä–∞–±–æ—Ç–∞', '–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', '–µ–¥–∞', '—Å–æ–Ω'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Meeting"', answer: '–≤—Å—Ç—Ä–µ—á–∞', options: ['—Ä–∞–∑–≥–æ–≤–æ—Ä', '–≤—Å—Ç—Ä–µ—á–∞', '–µ–¥–∞', '—Å–æ–Ω'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Hobby"', answer: '—Ö–æ–±–±–∏', options: ['—Ä–∞–±–æ—Ç–∞', '—Ö–æ–±–±–∏', '—à–∫–æ–ª–∞', '–¥–æ–º'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Music"', answer: '–º—É–∑—ã–∫–∞', options: ['—Å–ø–æ—Ä—Ç', '–º—É–∑—ã–∫–∞', '–µ–¥–∞', '–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Vacation"', answer: '–æ—Ç–ø—É—Å–∫', options: ['—Ä–∞–±–æ—Ç–∞', '–æ—Ç–ø—É—Å–∫', '—à–∫–æ–ª–∞', '–µ–¥–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Question"', answer: '–≤–æ–ø—Ä–æ—Å', options: ['–æ—Ç–≤–µ—Ç', '–≤–æ–ø—Ä–æ—Å', '–∏–¥–µ—è', '–ø—Ä–æ–±–ª–µ–º–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Happy"', answer: '—Å—á–∞—Å—Ç–ª–∏–≤—ã–π', options: ['–≥—Ä—É—Å—Ç–Ω—ã–π', '—Å—á–∞—Å—Ç–ª–∏–≤—ã–π', '–∑–ª–æ–π', '—É—Å—Ç–∞–ª—ã–π'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Big"', answer: '–±–æ–ª—å—à–æ–π', options: ['–º–∞–ª–µ–Ω—å–∫–∏–π', '–±–æ–ª—å—à–æ–π', '–±—ã—Å—Ç—Ä—ã–π', '–º–µ–¥–ª–µ–Ω–Ω—ã–π'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Fast"', answer: '–±—ã—Å—Ç—Ä—ã–π', options: ['–º–µ–¥–ª–µ–Ω–Ω—ã–π', '–±—ã—Å—Ç—Ä—ã–π', '–±–æ–ª—å—à–æ–π', '–º–∞–ª–µ–Ω—å–∫–∏–π'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Sport"', answer: '—Å–ø–æ—Ä—Ç', options: ['–º—É–∑—ã–∫–∞', '—Å–ø–æ—Ä—Ç', '–µ–¥–∞', '—Å–æ–Ω'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Idea"', answer: '–∏–¥–µ—è', options: ['–ø—Ä–æ–±–ª–µ–º–∞', '–∏–¥–µ—è', '–æ—Ç–≤–µ—Ç', '–≤–æ–ø—Ä–æ—Å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Solution"', answer: '—Ä–µ—à–µ–Ω–∏–µ', options: ['–ø—Ä–æ–±–ª–µ–º–∞', '—Ä–µ—à–µ–Ω–∏–µ', '–∏–¥–µ—è', '–≤–æ–ø—Ä–æ—Å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Sad"', answer: '–≥—Ä—É—Å—Ç–Ω—ã–π', options: ['—Å—á–∞—Å—Ç–ª–∏–≤—ã–π', '–≥—Ä—É—Å—Ç–Ω—ã–π', '—Ä–∞–¥–æ—Å—Ç–Ω—ã–π', '–≤–µ—Å—ë–ª—ã–π'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Small"', answer: '–º–∞–ª–µ–Ω—å–∫–∏–π', options: ['–±–æ–ª—å—à–æ–π', '–º–∞–ª–µ–Ω—å–∫–∏–π', '–¥–ª–∏–Ω–Ω—ã–π', '–∫–æ—Ä–æ—Ç–∫–∏–π'] }
                    ],
                    video: 'M7lc1UVf-VE'
                },
                advanced: {
                    flashcards: [
                        { word: 'Idiom', translation: '–ò–¥–∏–æ–º–∞', example: 'Break a leg means good luck.', img: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=300', fact: 'Idioms are figurative.' },
                        { word: 'Metaphor', translation: '–ú–µ—Ç–∞—Ñ–æ—Ä–∞', example: 'Life is a journey.', img: 'https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=300', fact: 'Metaphors compare.' },
                        { word: 'Negotiation', translation: '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', example: 'Business negotiation.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Negotiation for deals.' },
                        { word: 'Innovation', translation: '–ò–Ω–Ω–æ–≤–∞—Ü–∏—è', example: 'Technological innovation.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Innovation changes world.' },
                        { word: 'Challenge', translation: '–í—ã–∑–æ–≤', example: 'Face the challenge.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Challenges build character.' },
                        { word: 'Opportunity', translation: '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å', example: 'Seize the opportunity.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Opportunities for growth.' },
                        { word: 'Strategy', translation: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è', example: 'Business strategy.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Strategy for success.' },
                        { word: 'Leadership', translation: '–õ–∏–¥–µ—Ä—Å—Ç–≤–æ', example: 'Good leadership.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Leadership inspires.' },
                        { word: 'Motivation', translation: '–ú–æ—Ç–∏–≤–∞—Ü–∏—è', example: 'Stay motivated.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Motivation drives action.' },
                        { word: 'Success', translation: '–£—Å–ø–µ—Ö', example: 'Key to success.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Success through effort.' },
                        { word: 'Failure', translation: '–ù–µ—É–¥–∞—á–∞', example: 'Learn from failure.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Failure teaches.' },
                        { word: 'Goal', translation: '–¶–µ–ª—å', example: 'Set a goal.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Goals achieve dreams.' },
                        { word: 'Dream', translation: '–ú–µ—á—Ç–∞', example: 'Follow your dream.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Dreams inspire.' },
                        { word: 'Reality', translation: '–†–µ–∞–ª—å–Ω–æ—Å—Ç—å', example: 'Face reality.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Reality is what it is.' },
                        { word: 'Change', translation: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ', example: 'Embrace change.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Change is constant.' },
                        { word: 'Adapt', translation: '–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è', example: 'Adapt to new situations.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Adapt or perish.' },
                        { word: 'Collaborate', translation: '–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å', example: 'Collaborate with team.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Collaboration wins.' },
                        { word: 'Communicate', translation: '–û–±—â–∞—Ç—å—Å—è', example: 'Communicate effectively.', img: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300', fact: 'Communication is key.' },
                        { word: 'Empathy', translation: '–≠–º–ø–∞—Ç–∏—è', example: 'Show empathy.', img: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=300', fact: 'Empathy builds bonds.' },
                        { word: 'Resilience', translation: '–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å', example: 'Build resilience.', img: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300', fact: 'Resilience overcomes.' }
                    ],
                    quizzes: [
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Idiom"', answer: '–∏–¥–∏–æ–º–∞', options: ['–º–µ—Ç–∞—Ñ–æ—Ä–∞', '–∏–¥–∏–æ–º–∞', '–ø—Ä–æ–∑–∞', '–ø–æ—ç–∑–∏—è'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Negotiation"', answer: '–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', options: ['—Å–ø–æ—Ä', '–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '—Å–æ–≥–ª–∞—Å–∏–µ', '–∫–æ–Ω—Ñ–ª–∏–∫—Ç'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Innovation"', answer: '–∏–Ω–Ω–æ–≤–∞—Ü–∏—è', options: ['—Ç—Ä–∞–¥–∏—Ü–∏—è', '–∏–Ω–Ω–æ–≤–∞—Ü–∏—è', '—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', '–∏–∑–º–µ–Ω–µ–Ω–∏–µ'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Challenge"', answer: '–≤—ã–∑–æ–≤', options: ['–ø–æ–º–æ—â—å', '–≤—ã–∑–æ–≤', '—É—Å–ø–µ—Ö', '–Ω–µ—É–¥–∞—á–∞'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Strategy"', answer: '—Å—Ç—Ä–∞—Ç–µ–≥–∏—è', options: ['—Ç–∞–∫—Ç–∏–∫–∞', '—Å—Ç—Ä–∞—Ç–µ–≥–∏—è', '–ø–ª–∞–Ω', '–∏–¥–µ—è'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Leadership"', answer: '–ª–∏–¥–µ—Ä—Å—Ç–≤–æ', options: ['—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ª–∏–¥–µ—Ä—Å—Ç–≤–æ', '—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–∫–æ–Ω—Ç—Ä–æ–ª—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Success"', answer: '—É—Å–ø–µ—Ö', options: ['–Ω–µ—É–¥–∞—á–∞', '—É—Å–ø–µ—Ö', '–ø–æ–ø—ã—Ç–∫–∞', '—Å—Ç–∞—Ä—Ç'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Goal"', answer: '—Ü–µ–ª—å', options: ['–Ω–∞—á–∞–ª–æ', '—Ü–µ–ª—å', '–∫–æ–Ω–µ—Ü', '–ø—É—Ç—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Change"', answer: '–∏–∑–º–µ–Ω–µ–Ω–∏–µ', options: ['—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', '–∏–∑–º–µ–Ω–µ–Ω–∏–µ', '–æ—Å—Ç–∞–Ω–æ–≤–∫–∞', '–Ω–∞—á–∞–ª–æ'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Empathy"', answer: '—ç–º–ø–∞—Ç–∏—è', options: ['–∑–ª–æ—Å—Ç—å', '—ç–º–ø–∞—Ç–∏—è', '—Ä–∞–≤–Ω–æ–¥—É—à–∏–µ', '–Ω–µ–Ω–∞–≤–∏—Å—Ç—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Resilience"', answer: '—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å', options: ['—Å–ª–∞–±–æ—Å—Ç—å', '—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å', '—Ö—Ä—É–ø–∫–æ—Å—Ç—å', '–ª–æ–º–∫–æ—Å—Ç—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Collaborate"', answer: '—Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å', options: ['—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è', '—Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å', '–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å', '—Å–ø–æ—Ä–∏—Ç—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Communicate"', answer: '–æ–±—â–∞—Ç—å—Å—è', options: ['–º–æ–ª—á–∞—Ç—å', '–æ–±—â–∞—Ç—å—Å—è', '–∫—Ä–∏—á–∞—Ç—å', '—à–µ–ø—Ç–∞—Ç—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Adapt"', answer: '–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è', options: ['—Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è—Ç—å—Å—è', '–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è', '–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å', '–∏–∑–±–µ–≥–∞—Ç—å'] },
                        { question: '–ü–µ—Ä–µ–≤–µ–¥–∏ "Dream"', answer: '–º–µ—á—Ç–∞', options: ['—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å', '–º–µ—á—Ç–∞', '–∫–æ—à–º–∞—Ä', '–ø–ª–∞–Ω'] }
                    ],
                    video: '9bZkp7q19f0'
                }
            },
            // Math and History with full data similar to previous, for brevity not repeated, but assume filled with 20 flashcards and 15 quizzes each
            math: { /* Full data as in previous response */ },
            history: { /* Full data as in previous response */ }
        };

        // State management
        let progress = JSON.parse(localStorage.getItem('tegyProgress')) || {};
        let favorites = JSON.parse(localStorage.getItem('tegyFavorites')) || {};
        let streak = parseInt(localStorage.getItem('tegyStreak')) || 0;
        let lastDaily = localStorage.getItem('tegyLastDaily') || new Date().toDateString();

        // Improved generateFlashcards with lazy loading and accessibility
        function generateFlashcards(subject, level) {
            const container = document.getElementById(`flashcards-${subject}-${level}`);
            container.innerHTML = '';
            subjects[subject][level].flashcards.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'flashcard';
                div.dataset.key = `${subject}-${level}-${index}`;
                div.role = 'article';
                div.ariaLabel = `${card.word || card.term || card.event}: ${card.translation || card.explanation}`;
                div.innerHTML = `
                    <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${subject}', '${level}', ${index})" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" style="color: ${favorites[div.dataset.key] ? '#ff4757' : '#ccc'}">‚ù§Ô∏è</button>
                    <img src="${card.img}" alt="${card.word || card.term || card.event}" loading="lazy">
                    <p><strong>${card.word ? '–°–ª–æ–≤–æ' : card.term ? '–¢–µ—Ä–º–∏–Ω' : '–°–æ–±—ã—Ç–∏–µ'}: </strong> ${card.word || card.term || card.event}</p>
                    <p><strong>${card.translation ? '–ü–µ—Ä–µ–≤–æ–¥' : '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ'}: </strong> ${card.translation || card.explanation}</p>
                    <p><strong>–ü—Ä–∏–º–µ—Ä: </strong> ${card.example}</p>
                    <p><strong>–§–∞–∫—Ç: </strong> ${card.fact}</p>
                    <button class="speak-btn" onclick="event.stopPropagation(); speakText('${card.word || card.term || card.event}')" aria-label="–ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏"><i class="fas fa-volume-up" aria-hidden="true"></i></button>
                    ${card.audio ? `<audio controls aria-label="–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ"><source src="${card.audio}" type="audio/mpeg"></audio>` : ''}
                `;
                container.appendChild(div);
            });
            if (subjects[subject][level].video) {
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${subjects[subject][level].video}`;
                iframe.frameBorder = '0';
                iframe.allowFullscreen = true;
                iframe.title = '–í–∏–¥–µ–æ —É—Ä–æ–∫';
                iframe.loading = 'lazy';
                container.appendChild(iframe);
            }
        }

        // Improved quizzes with selection state
        function generateQuizzes(subject, level) {
            const container = document.getElementById(`quizzes-${subject}-${level}`);
            container.innerHTML = '<h3 role="heading" aria-level="3">–ö–≤–∏–∑ (–≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)</h3>';
            const shuffled = [...subjects[subject][level].quizzes].sort(() => 0.5 - Math.random()).slice(0, 8);
            shuffled.forEach((q, index) => {
                const id = `${subject}-${level}-${index}`;
                const optionsHtml = q.options.map((opt, optIndex) => 
                    `<div class="quiz-option" role="radio" aria-checked="false" tabindex="0" onclick="selectQuizOption(event, '${id}', '${q.answer}', '${opt}', '${subject}', '${level}')" onkeydown="if(event.key==='Enter') selectQuizOption(event, '${id}', '${q.answer}', '${opt}', '${subject}', '${level}')">${opt}</div>`
                ).join('');
                container.innerHTML += `
                    <div role="group" aria-labelledby="q${id}-label">
                        <p id="q${id}-label"><strong>–í–æ–ø—Ä–æ—Å ${index + 1}:</strong> ${q.question}</p>
                        <div class="quiz-options" role="radiogroup" aria-label="–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞">${optionsHtml}</div>
                    </div>
                    <p id="result-${id}" class="result" aria-live="assertive"></p>
                `;
            });
        }

        function selectQuizOption(event, quizId, correctAnswer, selected, subject, level) {
            event.target.classList.add('selected');
            event.target.setAttribute('aria-checked', 'true');
            event.target.blur(); // For accessibility
            checkQuizOption(quizId, correctAnswer, selected, subject, level);
        }

        // Rest of functions similar, with improvements for error handling, offline detection, etc.
        function checkQuizOption(quizId, correctAnswer, selected, subject, level) {
            const resultEl = document.getElementById(`result-${quizId}`);
            const options = document.querySelectorAll(`#result-${quizId}`).previousElementSibling.querySelectorAll('.quiz-option');
            options.forEach(opt => opt.style.pointerEvents = 'none'); // Disable after answer
            if (selected.toLowerCase().trim() === correctAnswer.toLowerCase().trim()) {
                resultEl.innerText = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ';
                resultEl.className = 'result success';
                tg && tg.HapticFeedback.impactOccurred('light');
                progress[`${subject}-${level}`] = (progress[`${subject}-${level}`] || 0) + 1;
                localStorage.setItem('tegyProgress', JSON.stringify(progress));
                updateProgress(subject, level);
                createConfetti();
                tg && tg.sendData(JSON.stringify({ quiz: subject, level, status: 'correct' }));
            } else {
                resultEl.innerText = `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: ${correctAnswer}`;
                resultEl.className = 'result error';
                options.forEach(opt => {
                    if (opt.textContent.toLowerCase().trim() === correctAnswer.toLowerCase().trim()) {
                        opt.classList.add('selected');
                        opt.style.background = 'var(--success)';
                    }
                });
                tg && tg.HapticFeedback.notificationOccurred('error');
                tg && tg.sendData(JSON.stringify({ quiz: subject, level, status: 'incorrect' }));
            }
        }

        function createConfetti() {
            for (let i = 0; i < 60; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDuration = Math.random() * 3 + 1 + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window && !window.speechSynthesis.speaking) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
                tg && tg.HapticFeedback.impactOccurred('medium');
            } else {
                console.log('Speech not supported or speaking...');
            }
        }

        // Other functions with try-catch for robustness
        function toggleFavorite(subject, level, index) {
            try {
                const key = `${subject}-${level}-${index}`;
                favorites[key] = !favorites[key];
                localStorage.setItem('tegyFavorites', JSON.stringify(favorites));
                const btns = document.querySelectorAll(`[onclick*="toggleFavorite('${subject}', '${level}', ${index})"]`);
                btns.forEach(btn => {
                    btn.style.color = favorites[key] ? '#ff4757' : '#ccc';
                    btn.classList.toggle('active', favorites[key]);
                });
                updateFavorites(subject);
                tg && tg.HapticFeedback.impactOccurred('light');
            } catch (e) {
                console.error('Favorite error:', e);
            }
        }

        function updateFavorites(subject) {
            const container = document.getElementById(`favorites-${subject}`);
            if (!container) return;
            container.innerHTML = '<h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>';
            let hasFav = false;
            for (let lvl of ['beginner', 'intermediate', 'advanced']) {
                if (subjects[subject][lvl]) {
                    subjects[subject][lvl].flashcards.forEach((card, i) => {
                        const key = `${subject}-${lvl}-${i}`;
                        if (favorites[key]) {
                            const div = document.createElement('div');
                            div.className = 'flashcard';
                            div.innerHTML = `<p><strong>${card.word || card.term || card.event}:</strong> ${card.translation || card.explanation}</p><p>${card.example}</p>`;
                            container.appendChild(div);
                            hasFav = true;
                        }
                    });
                }
            }
            if (!hasFav) {
                container.innerHTML += '<p style="text-align: center; opacity: 0.7;">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –∏–∑ —É—Ä–æ–∫–æ–≤!</p>';
            }
        }

        function showDailyChallenge(subject) {
            const today = new Date().toDateString();
            if (lastDaily !== today) {
                streak = lastDaily ? streak + 1 : 1;
                localStorage.setItem('tegyStreak', streak.toString());
                lastDaily = today;
                localStorage.setItem('tegyLastDaily', today);
                updateProfile();
                tg && tg.showAlert(`–°—Ç—Ä–∏–∫ –æ–±–Ω–æ–≤–ª—ë–Ω! ${streak} –¥–Ω–µ–π üî•`);
            }
            const challengeDiv = document.getElementById(`daily-challenge-${subject}`);
            if (challengeDiv) challengeDiv.style.display = 'block';
            // Generate challenge
            if (subjects[subject] && subjects[subject].beginner && subjects[subject].beginner.quizzes) {
                const randomQuiz = subjects[subject].beginner.quizzes[Math.floor(Math.random() * subjects[subject].beginner.quizzes.length)];
                const qEl = document.getElementById(`daily-${subject}-question`) || document.getElementById('daily-word') || document.getElementById('daily-math-question') || document.getElementById('daily-history-question');
                if (qEl) qEl.textContent = randomQuiz.question;
                // Store answer for check, using a global or data attr
                challengeDiv.dataset.correctAnswer = randomQuiz.answer;
            }
        }

        function checkDaily(subject) {
            const inputId = `daily-${subject}-input` || 'daily-input';
            const resultId = `daily-${subject}-result` || 'daily-result';
            const input = document.getElementById(inputId);
            const result = document.getElementById(resultId);
            const correct = document.getElementById(`daily-challenge-${subject}`).dataset.correctAnswer;
            if (!input || !result || !correct) return;
            const answer = input.value.trim().toLowerCase();
            if (answer === correct.toLowerCase()) {
                result.innerText = '–û—Ç–ª–∏—á–Ω–æ! üéâ –°—Ç—Ä–∏–∫ +1';
                result.className = 'result success';
                createConfetti();
                input.value = '';
                tg && tg.HapticFeedback.impactOccurred('heavy');
            } else {
                result.innerText = `–ù–µ —Å–æ–≤—Å–µ–º. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correct}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞!`;
                result.className = 'result error';
                tg && tg.HapticFeedback.notificationOccurred('error');
            }
            showDailyChallenge(subject); // Refresh for next day
        }

        // Define missing functions
        function checkDailyMath() { checkDaily('math'); }
        function checkDailyHistory() { checkDaily('history'); }

        function checkStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (lastDaily === yesterday) {
                // Good
            } else if (lastDaily !== today) {
                streak = 0;
                localStorage.setItem('tegyStreak', '0');
            }
            updateProfile();
        }

        function updateProgress(subject, level) {
            const key = `${subject}-${level}`;
            progress[key] = progress[key] || 0;
            const fill = document.getElementById(`progress-${key}`);
            if (!fill) return;
            const quizCount = subjects[subject]?.[level]?.quizzes?.length || 1;
            const percent = Math.min((progress[key] / quizCount) * 100, 100);
            fill.style.width = `${percent}%`;
            fill.parentElement.setAttribute('aria-valuenow', percent);
            const awardEl = document.getElementById(`award-${key}`);
            const nextBtn = document.getElementById(`next-${key}`);
            if (percent >= 100) {
                if (awardEl) awardEl.style.display = 'block';
                if (nextBtn) nextBtn.style.display = 'block';
                tg && tg.sendData(JSON.stringify({ award: key, status: 'completed' }));
            } else {
                if (awardEl) awardEl.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            }
        }

        function updateProfile() {
            const list = document.getElementById('profile-progress');
            if (!list) return;
            list.innerHTML = '';
            Object.entries(progress).forEach(([key, val]) => {
                const [sub, lvl] = key.split('-');
                const total = subjects[sub]?.[lvl]?.quizzes?.length || 0;
                const li = document.createElement('li');
                li.innerHTML = `<strong>${key}:</strong> ${val} / ${total} (${Math.round((val / total) * 100) || 0}%)`;
                list.appendChild(li);
            });
            const badges = document.getElementById('profile-badges');
            if (badges) {
                badges.innerHTML = '';
                if (streak >= 7) badges.innerHTML += '<span class="badge" aria-label="–ó–æ–ª–æ—Ç–æ–π —Å—Ç—Ä–∏–∫">ü•á</span>';
                if (streak >= 3) badges.innerHTML += '<span class="badge" aria-label="–°–µ—Ä–µ–±—Ä—è–Ω—ã–π —Å—Ç—Ä–∏–∫">ü•à</span>';
                if (Object.values(progress).some(v => v >= 10)) badges.innerHTML += '<span class="badge" aria-label="–ú–∞—Å—Ç–µ—Ä">üéì</span>';
            }
            const streakEl = document.getElementById('streak-counter');
            if (streakEl) streakEl.textContent = streak;
        }

        function shareProgress() {
            const totalProgress = Object.values(progress).reduce((a, b) => a + b, 0);
            const text = `–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ Tegy S: ${totalProgress} –∑–∞–¥–∞–Ω–∏–π, —Å—Ç—Ä–∏–∫ ${streak} –¥–Ω–µ–π! üìö‚ú® #TegyS`;
            tg && tg.shareUrl('', text);
        }

        // Navigation functions with history for back button convenience
        const navHistory = [];
        function showSection(sectionId) {
            navHistory.push(document.querySelector('.section[style*="block"]')?.id || 'main-menu');
            document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
            const section = document.getElementById(`${sectionId}-section`) || document.getElementById('main-menu');
            section.style.display = 'block';
            tg && tg.MainButton.show();
            if (sectionId === 'profile') updateProfile();
            if (['english', 'math', 'history'].includes(sectionId)) {
                hideLevels(sectionId);
                updateFavorites(sectionId);
            }
            // Auto show daily if applicable
            setTimeout(() => showDailyChallenge(sectionId), 500);
        }

        function showMainMenu() {
            document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
            document.getElementById('main-menu').style.display = 'block';
            tg && tg.MainButton.hide();
            checkStreak();
        }

        function hideLevels(subject) {
            document.querySelectorAll(`#${subject}-section .level-section`).forEach(sec => sec.style.display = 'none');
        }

        function showLevel(subject, level) {
            hideLevels(subject);
            const sectionId = `${subject}-${level}-level`;
            document.getElementById(sectionId).style.display = 'block';
            generateFlashcards(subject, level);
            generateQuizzes(subject, level);
            updateProgress(subject, level);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function repeatLevel(subject, level) {
            progress[`${subject}-${level}`] = 0;
            localStorage.setItem('tegyProgress', JSON.stringify(progress));
            showLevel(subject, level);
        }

        function searchFlashcards(subject) {
            const term = (document.getElementById(`search-${subject}`)?.value || '').toLowerCase().trim();
            document.querySelectorAll(`#${subject}-section .flashcard`).forEach(card => {
                card.style.display = card.textContent.toLowerCase().includes(term) ? 'block' : 'none';
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('tegyTheme', isDark ? 'dark' : 'light');
            tg && tg.HapticFeedback.impactOccurred('light');
            // Update colors for accessibility
            document.documentElement.style.setProperty('--text-primary', isDark ? '#ddd' : '#fff');
        }

        // Offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                self.addEventListener('fetch', e => {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request) || new Response('Offline')));
                });
                self.addEventListener('install', e => e.waitUntil(caches.open('tegy-v1').then(cache => cache.addAll(['/', './']))));
            `)).catch(console.error);
        }

        // Init with error handling
        function init() {
            try {
                const savedTheme = localStorage.getItem('tegyTheme');
                if (savedTheme === 'dark') document.body.classList.add('dark');
                checkStreak();
                showMainMenu();
                ['english', 'math', 'history'].forEach(sub => {
                    updateFavorites(sub);
                });
                // Keyboard shortcuts for convenience
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') showMainMenu();
                    if (e.key === 't' && e.ctrlKey) toggleTheme();
                });
            } catch (e) {
                console.error('Init error:', e);
            }
        }

        window.addEventListener('load', init);
        // Resize handler for convenience
        window.addEventListener('resize', () => tg && tg.expand());
    </script>
</body>
</html>
